---
title: "Tamaño de muestra Costa Rica"
author: "José Fernando Zea - Andrés Gutiérrez"
date: '2022-06-09'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

El proceso para la estimación del tamaño de muestra se divide en los siguientes procesos:

1. Carga e instalación de librerías

2. Lectura de datos y preprocesamiento

3. Deficinión diseño muestral y estimación de parámetros

4. Parámetros para tablas de muestreo
4.1. Población económicamente activa
4.2. Correlación intraclásica

5. Tablas de muestreo
  5.1. Configuración de estimaciones puntuales y medidas de precisión
  5.2. Estimación de otras medidas de precisión para los valores fijados para las diferentes          variables trazadoras
  5.3. Generación de las tablas de muestreo
  5.4. Integración de tablas nacionales

6. Integración de costos a las tablas de muestreo

7. Exportación de los resultados

# 1. Carga e instalación de librerías

```{r, warning=FALSE, message=FALSE}
# install.packages(pacman)
is_pacman <- require(pacman)
if(!is_pacman) install.packages("pacman") else library(pacman)
library(pacman)
p_load(haven, labelled, srvyr, samplesize4surveys, flextable, dplyr, arrow, writexl, tidyr)
options(survey.adjust.domain.lonely=TRUE)
options(survey.lonely.psu="adjust")
```


# 2. Lectura de datos y preprocesamiento

Cargamos el modelo de costos para las tablas de muestreo:

```{r, warning=FALSE, message=FALSE}
setwd("../output")
load( "modelo_Costos_V2.Rdata")
```

Se exporta el censo poblacional con el proposito de conocer el número de UPMs:

```{r, warning=FALSE, message=FALSE}
setwd("../data/")
df_censo <- open_dataset("parquet")
```

También se exporta encuesta de hogares del año 2020, seleccionaremos los insumos necesarios para calcular el tamaño de muestra para las encuestas multipropositos en el período intercensal. Se utilizarán como indicadores trazadoras la tasa de desocación, la pobreza monetaria y el índice de pobreza multidimensional: 

```{r, warning=FALSE, message=FALSE}
setwd("../data/encuesta")
df_encuesta <- read_dta("CRI_2019N1.dta")
```


```{r, warning=FALSE, message=FALSE}
setwd("../data/encuesta")
df_encuesta <- read_dta("CRI_2019N1.dta")
df_encuesta %<>% select(id_hogar, id_pers, 
                        region, areageo, areageo2,
                        upm = `_upm`, factorex = `_fep`, condact3,
                        pobreza, edad, 
                        starts_with("nbi_"))
```

El identificador de las encuestas está conformado por la concatenación del identificador del hogar y la persona:

```{r, warning=FALSE, message=FALSE}
# prueba id: id hogar  y persona
df_encuesta %<>% mutate(id_hogper = paste0(id_hogar, "_", id_pers))
test_duplicados <- table(duplicated(df_encuesta$id_hogper))
```

* El número de personas es: `r length(unique(df_encuesta$id_hogper))`
* El número de hogares es : `r length(unique(df_encuesta$id_hogar))`

Se utilizará como estrato de diseño la combinación de región y área:

```{r, warning=FALSE, message=FALSE}
df_encuesta %<>% mutate(region_area = paste0(region, "_", areageo))
```

Construimos el NBI promediando las 8 dimensiones del NBI:

```{r, warning=FALSE, message=FALSE}
df_encuesta %<>% mutate(NBI = (nbi_agua_ee + nbi_saneamiento_ee + 
                                 nbi_elect_ee + nbi_combus_ee + 
                                 nbi_interhog_ee + nbi_compuhog_ee + 
                                 nbi_pared_ee + nbi_piso_ee +
                                 nbi_techo_ee) / 9)
```


Por otro lado creamos variables dummies para la pobreza monetaria no extrema y la pobreza monetaria extrema:

```{r, warning=FALSE, message=FALSE}
df_encuesta %<>% mutate(pobreza_monet = ifelse(pobreza %in% 1:2, 1, 0),
                        pobreza_monet_extrema = ifelse(pobreza %in% 1, 1, 0))
```


Se construye la variable dummy para los desocupados:

```{r, warning=FALSE, message=FALSE}
df_encuesta %<>% mutate(ocupados = ifelse(condact3 == 1, 1, ifelse(condact3 == -1, NA, 0)),
                        desocupados = ifelse(condact3 == 2, 1, ifelse(condact3 == -1, NA, 0)),
                        inactivos = ifelse(condact3 == 3, 1, ifelse(condact3 == -1, NA, 0)),
                        activos = ocupados + desocupados,
                        poblacion_edadTrabajar = ocupados + desocupados + inactivos,
                         poblacion_edadTrabajar = ifelse(is.na(poblacion_edadTrabajar), 0, 
                                                          poblacion_edadTrabajar),
                        poblacion_EdadTrabajar2 = as.numeric(df_encuesta$edad >= 15))
# poblacion_edadTrabajar y poblacion_edadTrabajar generan los mismos valores
```

Calculamos el número de UPM's en el área urbana y rural, estas estadísticas son necesarios para calcular las tablas de muestreo. Para esto se hará uso del censo de población de Costa Rica del año 2011:

```{r, warning=FALSE, message=FALSE}
# UPM 5.251 no existe 
con_numUpmXzona <- df_censo %>% group_by(ID_ZONA, UPM2) %>% summarise(num_personas = n()) %>% 
  group_by(ID_ZONA) %>% summarise(num_upms = n()) %>% collect()
con_numUpmXzona %>% flextable()
```


# 3. Deficinión diseño muestral y estimación de parámetros

Definimos el diseño muestral detallando las UPM, estrato y factor de expansión, utilizamos para aproximar el diseño muestral la técnica del último conglomerado:

```{r, warning=FALSE, message=FALSE}
df_encuesta$id <- 1:nrow(df_encuesta)
df_encuesta$unos <- 1

# Tasa de ocupación –TO-: Es la relación porcentual entre la población ocupada y el número de personas que integran la población en edad de trabajar.

# Tasa global de participación –TGP-: Es la relación porcentual entre la población económicamente activa y la población en edad de trabajar. Este indicador refleja la presión de la población en edad de trabajar sobre el mercado laboral.

diseno_pobreza <- df_encuesta %>% as_survey_design(ids = upm,
                                        strata = region_area,  
                                        weights = factorex, nest = T)
   
df_estima_indicadores <- diseno_pobreza %>% group_by(areageo2) %>%
  summarize(pobreza = survey_mean(pobreza_monet, na.rm = T, deff = T),
            pobrezaExtr = survey_mean(pobreza_monet_extrema, na.rm = T, deff = T),
            NBI = survey_mean(NBI, na.rm = T, deff = T),
            tasa_desocupacion  = survey_ratio(desocupados, activos, na.rm = T, 
                                              deff = T),
            tasa_ocupacion = survey_ratio(ocupados, poblacion_EdadTrabajar2, 
                                          na.rm = T, 
                                          deff = T),
             tasa_participacion = survey_ratio(activos, poblacion_EdadTrabajar2,
                                               na.rm = T, deff = T), 
            N = survey_total(unos),
            N_activos = survey_total(activos, na.rm = T, deff = F)
            )

names(df_estima_indicadores)[names(df_estima_indicadores) == "pobreza"] <- "pobreza_prop"
names(df_estima_indicadores)[names(df_estima_indicadores) == "pobrezaExtr"] <- "pobrezaExtr_prop"
names(df_estima_indicadores)[names(df_estima_indicadores) == "NBI"] <- "NBI_prop"
names(df_estima_indicadores)[names(df_estima_indicadores) == "tasa_desocupacion"] <- "tasa_desocupacion_prop"
names(df_estima_indicadores)[names(df_estima_indicadores) == "tasa_ocupacion"] <- "tasa_ocupacion_prop"
names(df_estima_indicadores)[names(df_estima_indicadores) == "tasa_participacion"] <- "tasa_participacion_prop"
```


A continuación se editan los resultados anteriormente obtenidos:

```{r, warning=FALSE, message=FALSE}
conf <- 0.95
df_estima_indicadores <- df_estima_indicadores %>%
                    mutate(Area = names(val_labels(areageo2)),
                           
                           pobreza_prop = round(pobreza_prop, 2), 
                           pobreza_se = round(pobreza_se, 4),
                           pobreza_me = round(qnorm(1-(1-conf)/2) * pobreza_se, 4),
                           pobreza_mer = round(pobreza_me / pobreza_prop, 4),
                           pobreza_cve = round(100 * pobreza_se / pobreza_prop, 1),
                           pobreza_LI = pobreza_prop - pobreza_me,
                           pobreza_LS = pobreza_prop + pobreza_me,
                           pobreza_deff = round(pobreza_deff, 1),
                           
                           pobrezaExtr_prop = round(pobrezaExtr_prop, 2), 
                           pobrezaExtr_se = round(pobrezaExtr_se, 4),
                           pobrezaExtr_me = round(qnorm(1-(1-conf)/2) * pobrezaExtr_se,4),
                           pobrezaExtr_mer = round(pobrezaExtr_me / pobrezaExtr_prop, 4),
                           pobrezaExtr_cve = round(100 * pobrezaExtr_se / pobrezaExtr_prop, 1),
                           pobrezaExtr_LI = pobrezaExtr_prop - pobrezaExtr_me,
                           pobrezaExtr_LS = pobrezaExtr_prop + pobrezaExtr_me,
                           pobrezaExtr_deff = round(pobrezaExtr_deff, 1),
                           
                           NBI_prop = round(NBI_prop, 2),
                           NBI_se = round(NBI_se, 4),
                           NBI_me = round(qnorm(1-(1-conf)/2) * NBI_se,4),
                           NBI_mer = round(NBI_me / NBI_prop, 4),
                           NBI_cve = round(100 * NBI_se / NBI_prop,1),
                           NBI_LI = NBI_prop - NBI_me,
                           NBI_LS = NBI_prop + NBI_me,
                           NBI_deff = round(NBI_deff, 1),
                           
                tasa_desocupacion_prop = round(tasa_desocupacion_prop, 4),
                tasa_desocupacion_se = round(tasa_desocupacion_se, 4),
                tasa_desocupacion_me = round(qnorm(1-(1-conf)/2) * tasa_desocupacion_se,4),
                tasa_desocupacion_mer = round(tasa_desocupacion_me / tasa_desocupacion_prop, 4),
            tasa_desocupacion_cve = round(100 * tasa_desocupacion_se / tasa_desocupacion_prop, 2),
                tasa_desocupacion_LI = tasa_desocupacion_prop - tasa_desocupacion_me,
                tasa_desocupacion_LS = tasa_desocupacion_prop + tasa_desocupacion_me,
                tasa_desocupacion_deff = round(tasa_desocupacion_deff, 1),
                
                tasa_ocupacion_prop = round(tasa_ocupacion_prop, 4),
                tasa_ocupacion_se = round(tasa_ocupacion_se, 4),
                tasa_ocupacion_me = round(qnorm(1-(1-conf)/2) * tasa_ocupacion_se,4),
                tasa_ocupacion_mer = round(tasa_ocupacion_me / tasa_ocupacion_prop, 4),
                tasa_ocupacion_cve = round(100 * tasa_ocupacion_se / tasa_ocupacion_prop, 2),
                tasa_ocupacion_LI = tasa_ocupacion_prop - tasa_ocupacion_me,
                tasa_ocupacion_LS = tasa_ocupacion_prop + tasa_ocupacion_me,
                tasa_ocupacion_deff = round(tasa_ocupacion_deff, 1),
                
                tasa_participacion_prop = round(tasa_participacion_prop, 4),
                tasa_participacion_se = round(tasa_participacion_se, 4),
                tasa_participacion_me = round(qnorm(1-(1-conf)/2) * tasa_participacion_se,4),
                tasa_participacion_mer = round(tasa_participacion_me / tasa_participacion_prop, 4),
                tasa_participacion_cve = round(100 * tasa_participacion_se / tasa_participacion_prop, 2),
                tasa_participacion_LI = tasa_participacion_prop - tasa_participacion_me,
                tasa_participacion_LS = tasa_participacion_prop + tasa_participacion_me,
                tasa_participacion_deff = round(tasa_participacion_deff, 1)
                ) %>%
                    select(Area,
                           pobreza_prop, pobreza_se, pobreza_me, pobreza_mer,
                           pobreza_cve, pobreza_LI, pobreza_LS, pobreza_deff,
                           pobrezaExtr_prop, pobrezaExtr_se, pobrezaExtr_me, pobrezaExtr_mer,
                           pobrezaExtr_cve, pobrezaExtr_LI, pobrezaExtr_LS, pobrezaExtr_deff,
                           NBI_prop, NBI_se, NBI_me, NBI_mer,
                           NBI_cve, NBI_LI, NBI_LS, NBI_deff,
      tasa_desocupacion_prop, tasa_desocupacion_se, tasa_desocupacion_me, tasa_desocupacion_mer,
      tasa_desocupacion_cve, tasa_desocupacion_LI, tasa_desocupacion_LS, tasa_desocupacion_deff,
      tasa_ocupacion_prop, tasa_ocupacion_se, tasa_ocupacion_me, tasa_ocupacion_mer,
      tasa_ocupacion_cve, tasa_ocupacion_LI, tasa_ocupacion_LS, tasa_ocupacion_deff,
      tasa_participacion_prop, tasa_participacion_se, tasa_participacion_me, tasa_participacion_mer,
      tasa_participacion_cve, tasa_participacion_LI, tasa_participacion_LS, tasa_participacion_deff,
      N_activos, N 
          )
```

Presentamos a continuación las estimaciones resultantes


```{r, warning=FALSE, message=FALSE}
df_estima_pobreza <- df_estima_indicadores %>% select(Area, starts_with("pobreza_")) %>% 
                     pivot_longer(starts_with("pobreza_"), 
                                        names_to = "variable",
                                        values_to = "indicador") %>%
  reshape2::dcast(formula =  variable ~ Area , value.var = "indicador") %>%
  mutate(variable = gsub("pobreza_", "", variable)) %>% 
  select(Estimadores = variable, Urbano, Rural)
df_estima_pobreza <- df_estima_pobreza[
      match(c("prop", "se", "me", "mer", "cve", "LI", "LS", "deff"),   
           df_estima_pobreza$Estimadores), ]
```

```{r}
df_estima_pobrezaExtrema <- df_estima_indicadores %>% select(Area, starts_with("pobrezaExtr_")) %>% 
                          pivot_longer(starts_with("pobrezaExtr_"), 
                                        names_to = "variable",
                                        values_to = "indicador") %>%
  reshape2::dcast(formula =  variable ~ Area , value.var = "indicador") %>%
  mutate(variable = gsub("pobrezaExtr_", "", variable)) %>%
select(Estimadores = variable, Urbano, Rural) 
df_estima_pobrezaExtrema <- df_estima_pobrezaExtrema[
      match(c("prop", "se", "me", "mer", "cve", "LI", "LS", "deff"),   
           df_estima_pobrezaExtrema$Estimadores),]
```




```{r, warning=FALSE, message=FALSE}
df_estima_NBI <- df_estima_indicadores %>% select(Area, starts_with("NBI_")) %>% 
                          pivot_longer(starts_with("NBI_"), 
                                        names_to = "variable",
                                        values_to = "indicador") %>%
  reshape2::dcast(formula =  variable ~ Area , value.var = "indicador") %>%
  mutate(variable = gsub("NBI_", "", variable)) %>%
  select(Estimadores = variable, Urbano, Rural) 
  df_estima_NBI <- df_estima_NBI[
      match(c("prop", "se", "me", "mer", "cve", "LI", "LS", "deff"),   
           df_estima_NBI$Estimadores),]
```


```{r, warning=FALSE, message=FALSE}
df_estima_tasa_desocupacion <- df_estima_indicadores %>% select(Area, starts_with("tasa_desocupacion_")) %>% 
                          pivot_longer(starts_with("tasa_desocupacion_"), 
                                        names_to = "variable",
                                        values_to = "indicador") %>%
  reshape2::dcast(formula =  variable ~ Area , value.var = "indicador") %>%
  mutate(variable = gsub("tasa_desocupacion_", "", variable)) %>%
  select(Estimadores = variable, Urbano, Rural) 
  df_estima_tasa_desocupacion <- df_estima_tasa_desocupacion[
      match(c("prop", "se", "me", "mer", "cve", "LI", "LS", "deff"),   
           df_estima_tasa_desocupacion$Estimadores),]
```


```{r, warning=FALSE, message=FALSE}
df_estima_tasa_ocupacion <- df_estima_indicadores %>% select(Area, starts_with("tasa_ocupacion_")) %>% 
                          pivot_longer(starts_with("tasa_ocupacion_"), 
                                        names_to = "variable",
                                        values_to = "indicador") %>%
  reshape2::dcast(formula =  variable ~ Area , value.var = "indicador") %>%
  mutate(variable = gsub("tasa_ocupacion_", "", variable)) %>%
  select(Estimadores = variable, Urbano, Rural) 
  df_estima_tasa_ocupacion <- df_estima_tasa_ocupacion[
      match(c("prop", "se", "me", "mer", "cve", "LI", "LS", "deff"),   
           df_estima_tasa_ocupacion$Estimadores),]
```


```{r, warning=FALSE, message=FALSE}
df_estima_tasa_participacion <- df_estima_indicadores %>% 
                                select(Area, starts_with("tasa_participacion_")) %>% 
                          pivot_longer(starts_with("tasa_participacion_"), 
                                        names_to = "variable",
                                        values_to = "indicador") %>%
  reshape2::dcast(formula =  variable ~ Area , value.var = "indicador") %>%
  mutate(variable = gsub("tasa_participacion_", "", variable)) %>%
  select(Estimadores = variable, Urbano, Rural) 
  df_estima_tasa_participacion <- df_estima_tasa_participacion[
      match(c("prop", "se", "me", "mer", "cve", "LI", "LS", "deff"),   
           df_estima_tasa_participacion$Estimadores),]
```

Los indicadores de pobreza son:

```{r, warning=FALSE, message=FALSE}
TablaEditada_Pobrezas <- cbind(df_estima_NBI, df_estima_pobreza[,-1],
                               df_estima_pobrezaExtrema[,-1])
colnames(TablaEditada_Pobrezas) <- c("Estimadores", 
                                     "Urbano_NBI", "Rural_NBI", 
                                     "Urbano_Pob", "Rural_Pob", 
                                     "Urbano_PobExtrem","Rural_PobExtrem")

tipologias_pobrezas <- data.frame(col_keys = colnames(TablaEditada_Pobrezas),
                         what = c("Estimadores", "NBI", "NBI", "Pobreza", "Pobreza",
                                  "Pobreza Extrema", "Pobreza Extrema"),
                         measure = c("Estimadores", "Urbano", "Rural", "Urbano", "Rural",
                                                 "Urbano", "Rural"))  
TablaEditada_Pobrezas_ft <- TablaEditada_Pobrezas %>%  flextable() %>% 
  set_header_df(mapping = tipologias_pobrezas, key = "col_keys") %>%
  merge_h(part = "header") %>% set_header_df(mapping = tipologias_pobrezas, key = "col_keys") %>%
   merge_v(j = "Estimadores", part = "header") %>%
   merge_at(i = 1, j = 2:3, part = "header") %>% 
  merge_at(i = 1, j = 4:5, part = "header") %>% 
  merge_at(i = 1, j = 6:7, part = "header") %>% theme_vanilla() %>%
  fix_border_issues()
TablaEditada_Pobrezas_ft %>% print()
```
Las estimación de la tasa de desocupación, ocupación y de participación:

```{r, warning=FALSE, message=FALSE}
TablaEditada_DesocOcupPartic <- cbind(df_estima_tasa_desocupacion,
                                      df_estima_tasa_ocupacion[,-1],
                               df_estima_tasa_participacion[,-1])
colnames(TablaEditada_DesocOcupPartic) <- c("Estimadores",
                                     "Urbano_tasa_desocupacion", "Rural_tasa_desocupacion",
                                     "Urbano_tasa_ocupacion", "Rural_tasa_ocupacion",
                                     "Urbano_tasa_participacion", "Rural_tasa_participacion")

tipologias_DesocOcupPartic <- data.frame(col_keys = colnames(TablaEditada_DesocOcupPartic),
                         what = c("Estimadores", "Tasa desocupación", "Tasa desocupación",
                                  "Tasa ocupación", "Tasa ocupación",
                                  "Tasa participación", "Tasa participación"),
                         measure = c("Estimadores", "Urbano", "Rural", "Urbano", "Rural",
                                                 "Urbano", "Rural"))  
TablaEditada_DesocOcupPartic_ft <- TablaEditada_DesocOcupPartic %>%  flextable() %>% 
  set_header_df(mapping = tipologias_DesocOcupPartic, key = "col_keys") %>%
  merge_h(part = "header") %>% 
  set_header_df(mapping = tipologias_DesocOcupPartic, key = "col_keys") %>%
   merge_v(j = "Estimadores", part = "header") %>%
   merge_at(i = 1, j = 2:3, part = "header") %>% 
  merge_at(i = 1, j = 4:5, part = "header") %>% 
  merge_at(i = 1, j = 6:7, part = "header") %>% theme_vanilla() %>%
  fix_border_issues()
TablaEditada_DesocOcupPartic_ft %>% print()
```




# 4. Parámetros para tablas de muestreo

El objetivo de los procesos desarrollados en el script es generar diferentes tamaños de muestra para el área urbana, rural y nacional para los siguientes indicadores:

* Razón (tasa) de desocupación
* Razón (tasa) de ocupación
* Razón (tasa) de participación
* Pobreza monetaria no extrema
* Pobreza monetaria extrema
* Necesidades básicas insatisfechas (NBI)

En primer lugar generamos una tabla a partir de información censal y de la encuesta y con los siguientes argumentos los cuales deben ser especificados como argumentos en la función. La función tiene dos vectores que se debe establecer:

* Los margenes de error de cada indicador: me_tasa_desocupacion, me_pobMonet, me_pobMonetExtr, me_IPM, estos indicadores se establecerán a partir de las necesidades del Instituto Nacional de Estadística de Costa Rica y usuarios de la información: 
* Confiablidad de cada indicador (por defecto 0.95): conf_tasa_desocupacion, conf_pobMonet, conf_pobMonetExtr, conf_IPM

Es este paso se debe definir la precisión esperada en términos de coeficientes de variación (parámetros generales):

```{r, warning=FALSE, message=FALSE}
df_num_perXhog <- df_encuesta %>% group_by(areageo2, id_hogar) %>% summarise(cuenta = n()) %>% group_by(areageo2) %>% summarise(num_persXhog = mean(cuenta))

M_Urbana <- con_numUpmXzona$num_upms[con_numUpmXzona$ID_ZONA == 1]
M_rural <- con_numUpmXzona$num_upms[con_numUpmXzona$ID_ZONA == 2]

N_Urbana <- df_encuesta$factorex[df_encuesta$areageo2 == 1] %>% sum()
N_rural <- df_encuesta$factorex[df_encuesta$areageo2 == 2] %>% sum()

# Número de personas por hogar según el censo
b_Urbana <- df_num_perXhog$num_persXhog[df_num_perXhog$areageo2 == 1] 
b_rural <- df_num_perXhog$num_persXhog[df_num_perXhog$areageo2 == 2] 

# Número de hogares encuestadas por UPM (encuesta de hogares)
#nII_hog = df_encuesta %>% group_by(upm) %>% summarise(nII = n_distinct(id_hogar)) %>% pull(nII) %>% mean() 

nII_hog_Urbana = df_encuesta %>% filter(areageo == 1) %>% group_by(upm) %>% 
                summarise(nII = n_distinct(id_hogar)) %>% pull(nII) %>% mean() 
nII_hog_rural = df_encuesta %>% filter(areageo == 2) %>% group_by(upm) %>% 
                summarise(nII = n_distinct(id_hogar)) %>% pull(nII) %>% mean() 

# Número de personas encuestadas por UPM (encuesta de hogares)
#nII_pers = df_encuesta  %>% group_by(upm) %>% summarise(nII = n()) %>% pull(nII) %>% mean() 
nII_pers_Urbana = df_encuesta %>% filter(areageo == 1) %>% group_by(upm) %>% 
                  summarise(nII = n()) %>% pull(nII) %>% mean() 
nII_pers_rural = df_encuesta %>% filter(areageo == 2) %>% group_by(upm) %>% 
                 summarise(nII = n()) %>% pull(nII) %>% mean() 


df_ParamGenerales <- data.frame(Area = c("Urbana",  "Rural"), 
                         M = c(M_Urbana, M_rural),
                         N = c(N_Urbana, N_rural),
                         b = c(b_Urbana, b_rural),
                         nII_hog = c(nII_hog_Urbana, nII_hog_rural), 
                         # El número de hogares por UPM en la encuesta
                         nII_pers = c(nII_pers_Urbana, nII_pers_rural)
                         )
flextable(df_ParamGenerales)
```


## 4.1. Población económicamente activa

Para calcular las tablas de muestreo debemos calcular la proporción de población económicamente activa y la proporciónde hogares sobre los cuales se calcula los indicadores de pobreza (r = 1):

```{r}
r_pobreza_Urbana <- 1
r_pobreza_Rural <- 1

r_pobrezaExtr_Urbana <- 1
r_pobrezaExtr_Rural <- 1

r_NBI_Urbana <- 1
r_NBI_Rural <- 1

r_tasa_desocupacion_Urbana <-  sum(df_encuesta$activos[df_encuesta$areageo2 == 1] *                
                         df_encuesta$factorex[df_encuesta$areageo2 == 1], na.rm = T) /
                        sum(df_encuesta$factorex[df_encuesta$areageo2 == 1], na.rm = T)

r_tasa_desocupacion_Rural <-  sum(df_encuesta$activos[df_encuesta$areageo2 == 2] *                
                        df_encuesta$factorex[df_encuesta$areageo2 == 2], na.rm = T) /
                 sum(df_encuesta$factorex[df_encuesta$areageo2 == 2], na.rm = T)

r_tasa_ocupacion_Urbana <-  sum(df_encuesta$poblacion_EdadTrabajar2[df_encuesta$areageo2 == 1] *                                    df_encuesta$factorex[df_encuesta$areageo2 == 1], na.rm = T) /
                        sum(df_encuesta$factorex[df_encuesta$areageo2 == 1], na.rm = T)

r_tasa_ocupacion_Rural <-  sum(df_encuesta$poblacion_EdadTrabajar2[df_encuesta$areageo2 == 2] *                                    df_encuesta$factorex[df_encuesta$areageo2 == 2], na.rm = T) /
                           sum(df_encuesta$factorex[df_encuesta$areageo2 == 2], na.rm = T)


r_tasa_participación_Urbana <-  sum(df_encuesta$poblacion_EdadTrabajar2[df_encuesta$areageo2 == 1] *                                    df_encuesta$factorex[df_encuesta$areageo2 == 1], na.rm = T) /
                        sum(df_encuesta$factorex[df_encuesta$areageo2 == 1], na.rm = T)

r_tasa_participación_Rural <-  sum(df_encuesta$poblacion_EdadTrabajar2[df_encuesta$areageo2 == 2] *                                    df_encuesta$factorex[df_encuesta$areageo2 == 2], na.rm = T) /
                           sum(df_encuesta$factorex[df_encuesta$areageo2 == 2], na.rm = T)
```



```{r}
df_ParamGenerales$r_pobreza <- c(r_pobreza_Urbana, r_pobreza_Rural)
df_ParamGenerales$r_pobrezaExtr <- c(r_pobrezaExtr_Urbana, r_pobrezaExtr_Rural)
df_ParamGenerales$r_NBI <- c(r_NBI_Urbana, r_NBI_Rural)

df_ParamGenerales$r_tasa_desocupacion <- c(r_tasa_desocupacion_Urbana, r_tasa_desocupacion_Rural)
df_ParamGenerales$r_tasa_ocupacion <- c(r_tasa_ocupacion_Urbana, r_tasa_ocupacion_Rural)
df_ParamGenerales$r_tasa_participacion <- c(r_tasa_participación_Urbana, r_tasa_participación_Rural)

df_ParamGenerales %>% flextable()
```

## 4.2. Correlación intraclásica

El coeficiente de correlación de las variables de interés determina en gran medida el tamaño de las tablas de muestra.


A continuación estimamos el coeficiente de correlación intraclásica para la pobreza monetaria y el IPM con la encuesta de hogares de Costa Rica del año 2020:

```{r, warning=FALSE, message=FALSE}
f_indicador <- function(deff_indicador){
filtro_area_urbana <-  df_ParamGenerales$Area == "Urbana"
filtro_area_rural <-  df_ParamGenerales$Area == "Rural"

nII_pers_Urbana <- df_ParamGenerales$nII_pers[df_ParamGenerales$Area == "Urbana"]
nII_pers_Rural <- df_ParamGenerales$nII_pers[df_ParamGenerales$Area == "Rural"]

# deff =  1 + (n-1) * rho, despejando:  rho = (deff - 1) / (n - 1)
rho_Urbana <- (deff_indicador[filtro_area_urbana] - 1) / (nII_pers_Urbana - 1)
rho_Rural <- (deff_indicador[filtro_area_rural] - 1) / (nII_pers_rural - 1)
salida <- list(rho_Urbana, rho_Rural)
names(salida) <- c("rho_Urbana", "rho_Rural")
salida
}

rho_pobreza_Urbana <- f_indicador(df_estima_indicadores$pobreza_deff)$rho_Urbana
rho_pobreza_Rural <- f_indicador(df_estima_indicadores$pobreza_deff)$rho_Rural

rho_pobrezaExtr_Urbana <- f_indicador(df_estima_indicadores$pobrezaExtr_deff)$rho_Urbana
rho_pobrezaExtr_Rural <- f_indicador(df_estima_indicadores$pobrezaExtr_deff)$rho_Rural

rho_NBI_Urbana <- f_indicador(df_estima_indicadores$NBI_deff)$rho_Urbana
rho_NBI_Rural <- f_indicador(df_estima_indicadores$NBI_deff)$rho_Rural

rho_tasa_desocupacion_Urbana <- f_indicador(df_estima_indicadores$tasa_desocupacion_deff)$rho_Urbana
rho_tasa_desocupacion_Rural <- f_indicador(df_estima_indicadores$tasa_desocupacion_deff)$rho_Rural

rho_tasa_ocupacion_Urbana <- f_indicador(df_estima_indicadores$tasa_ocupacion_deff)$rho_Urbana
rho_tasa_ocupacion_Rural <- f_indicador(df_estima_indicadores$tasa_ocupacion_deff)$rho_Rural

rho_tasa_participacion_Urbana <- f_indicador(df_estima_indicadores$tasa_participacion_deff)$rho_Urbana
rho_tasa_participacion_Rural <- f_indicador(df_estima_indicadores$tasa_participacion_deff)$rho_Rural

df_rho <- data.frame(Area = c("Urbana", "Rural"), 
                             rho_pobreza = c(rho_pobreza_Urbana, rho_pobreza_Rural),
          rho_pobrezaExtrema = c(rho_pobrezaExtr_Urbana, rho_pobrezaExtr_Rural),
          rho_NBI = c(rho_NBI_Urbana, rho_NBI_Rural),
          rho_tasa_desocupacion = c(rho_tasa_desocupacion_Urbana, rho_tasa_desocupacion_Rural),
          rho_tasa_ocupacion = c(rho_tasa_ocupacion_Urbana, rho_tasa_ocupacion_Rural),
          rho_tasa_participacion = c(rho_tasa_participacion_Urbana, rho_tasa_participacion_Rural)
                             )

names(df_rho) <- c("Area", "rho pobreza.", "rho pobreza extrema","rho NBI", 
                   "rho Tasa desocupación", "rho Tasa ocupación", "rho tasa de participación")
flextable::flextable(df_rho)
```
El coeficiente de correlación intraclásica junto con los parámetros definidos inicialmente en la tabla df_parametros_TablasMuestreo permitirán elaborar las tablas de muestreo para los diferentes indicadores trazadoras de la encuesta.

# 5. Tablas de muestreo


Para elaborar las tablas de muestreo utilizaremos las medidas de precisión definidas por el INE de Costa Rica mediante sesiones de grupos focales. Las estimaciones puntuales se estimana a partir de la encuesta con excepción de la tasa de desocupación la cual en el año 2020 fue más alta que en años anteriores y siguientes (18 % y 15 %). Esta alta tasa de desempleo conlleva a tamaños de muestreo mucho menos existentes. Se fijará la tasa de desempleo en un 10%


## 5.1. Configuración de estimaciones puntuales y medidas de precisión

En esta parte es importante que los técnicos del INEC de Costa Rica configuren las proporciones esperadas y los coeficientes de variación máximos, a partir de las necesidades específicas del país, y en concordancia con las encuestas más recientes y el censo de población. 

```{r}
# Estos valores son fijados por el INE:

# tasa de desocupación fijado más baja que la estimación de la encuesta 2020
# Estos parámetros son los esperados en un periodo regular (fijado por el INE)
P_tasa_desocupacion_fijado_Urbana <- df_estima_indicadores$tasa_desocupacion_prop[df_estima_indicadores$Area == "Urbano"]
P_tasa_desocupacion_fijado_Rural <- df_estima_indicadores$tasa_desocupacion_prop[df_estima_indicadores$Area == "Rural"]

# Los coeficientes de variación vienen de una discusión interna con los usuarios 
# de la encuesta, en cuanto a la precisión esperada en el periodo intercensal
# Focus group
cve_tasa_desocupacion_deseado_Urbana <- 0.035
cve_tasa_desocupacion_deseado_Rural <- 0.038


# tasa de desocupación fijado más baja que la estimación de la encuesta 2020
# Estos parámetros son los esperados en un periodo regular (fijado por el INE)
P_tasa_ocupacion_fijado_Urbana <- df_estima_indicadores$tasa_ocupacion_prop[df_estima_indicadores$Area == "Urbano"]
P_tasa_ocupacion_fijado_Rural <- df_estima_indicadores$tasa_ocupacion_prop[df_estima_indicadores$Area == "Rural"]

# Los coeficientes de variación vienen de una discusión interna con los usuarios 
# de la encuesta, en cuanto a la precisión esperada en el periodo intercensal
# Focus group
cve_tasa_ocupacion_deseado_Urbana <- 0.035
cve_tasa_ocupacion_deseado_Rural <- 0.038




# tasa de desocupación fijado más baja que la estimación de la encuesta 2020
# Estos parámetros son los esperados en un periodo regular (fijado por el INE)
P_tasa_participacion_fijado_Urbana <- df_estima_indicadores$tasa_participacion_prop[df_estima_indicadores$Area == "Urbano"]
P_tasa_participacion_fijado_Rural <- df_estima_indicadores$tasa_participacion_prop[df_estima_indicadores$Area == "Rural"]

# Los coeficientes de variación vienen de una discusión interna con los usuarios 
# de la encuesta, en cuanto a la precisión esperada en el periodo intercensal
# Focus group
cve_tasa_participacion_deseado_Urbana <- 0.035
cve_tasa_participacion_deseado_Rural <- 0.038





# Estimaciones puntuales de indicadores de pobreza a partir de las encuestas
# ENAHO2020
P_pobreza_fijado_Urbana <- df_estima_indicadores$pobreza_prop[df_estima_indicadores$Area == "Urbano"]
P_pobreza_fijado_Rural <- df_estima_indicadores$pobreza_prop[df_estima_indicadores$Area == "Rural"]

# Los coeficientes de variación vienen de una discusión interna con los usuarios 
# de la encuesta, en cuanto a la precisión esperada en el periodo intercensal
# Focus group
cve_pobreza_deseado_Urbana <- 0.05
cve_pobreza_deseado_Rural <- 0.05



# Estimaciones puntuales de indicadores de pobreza a partir de las encuestas
# ENAHO2020
P_pobrezaExtr_fijado_Urbana <- df_estima_indicadores$pobrezaExtr_prop[df_estima_indicadores$Area == "Urbano"]
P_pobrezaExtr_fijado_Rural <- df_estima_indicadores$pobrezaExtr_prop[df_estima_indicadores$Area == "Rural"]

# Los coeficientes de variación vienen de una discusión interna con los usuarios 
# de la encuesta, en cuanto a la precisión esperada en el periodo intercensal
# Focus group
cve_pobrezaExtr_deseado_Urbana <- 0.09
cve_pobrezaExtr_deseado_Rural <- 0.09



# Estimaciones puntuales de indicadores de pobreza a partir de las encuestas
# ENAHO2020
P_NBI_fijado_Urbana <- df_estima_indicadores$NBI_prop[df_estima_indicadores$Area == "Urbano"]
P_NBI_fijado_Rural <- df_estima_indicadores$NBI_prop[df_estima_indicadores$Area == "Rural"]

# Los coeficientes de variación vienen de una discusión interna con los usuarios 
# de la encuesta, en cuanto a la precisión esperada en el periodo intercensal
# Focus group
cve_NBI_deseado_Urbana <- 0.05
cve_NBI_deseado_Rural <- 0.05





df_ValoresFijados <- data.frame(Area = c("Urbana", "Rural"),
                              pobreza_prop = c(P_pobreza_fijado_Urbana, P_pobreza_fijado_Rural),
                              pobreza_cve = c(cve_pobreza_deseado_Urbana, cve_pobreza_deseado_Rural),
                              pobrezaExtr_prop = c(P_pobrezaExtr_fijado_Urbana, P_pobrezaExtr_fijado_Rural),
                              pobrezaExtr_cve = c(cve_pobrezaExtr_deseado_Urbana, cve_pobrezaExtr_deseado_Rural),
                              NBI_prop = c(P_NBI_fijado_Urbana, P_NBI_fijado_Rural),
                              NBI_cve = c(cve_NBI_deseado_Urbana, cve_NBI_deseado_Rural),
                                tasa_desocupacion_prop = c(P_tasa_desocupacion_fijado_Urbana,             
                                                           P_tasa_desocupacion_fijado_Rural),
                                tasa_desocupacion_cve= c(cve_tasa_desocupacion_deseado_Urbana, 
                                                         cve_tasa_desocupacion_deseado_Rural),
                                tasa_ocupacion_prop = c(P_tasa_ocupacion_fijado_Urbana,             
                                                           P_tasa_ocupacion_fijado_Rural),
                                tasa_ocupacion_cve= c(cve_tasa_ocupacion_deseado_Urbana, 
                                                         cve_tasa_ocupacion_deseado_Rural),
                                tasa_participacion_prop = c(P_tasa_participacion_fijado_Urbana,             
                                                           P_tasa_participacion_fijado_Rural),
                                tasa_participacion_cve= c(cve_tasa_participacion_deseado_Urbana, 
                                                         cve_tasa_participacion_deseado_Rural)
                                 )

df_ValoresFijados %>% flextable()
```


## 5.2. Estimación de otras medidas de precisión para los valores fijados para las diferentes variables trazadoras

Para calcular las tablas de muestreo requerimos disponer del margen de error relativo, podemos calcular este indicador a partir del coeficiente de variación.

Recordemos que el coeficiente de variación estimado se calcula como el cociente entre el error estándar y el parámetro de interés:

$$
CVE = \frac{\sqrt{V}(\theta)}{\theta} = \frac{S_{\hat{\theta}}}{\hat\theta}
$$
Si conocemos el CVE y el parámetro podemos obtener S como sigue:

$$
S_{\hat{\theta}} = \hat{\theta}CVE
$$
Recordemos que el margen de error es:

$$
me = z_{1-\alpha/2}S_{\hat{\theta}}= z_{1-\alpha/2}\hat{\theta}CVE
$$

El margen de error relativo puede calcularse facilmente a partir del margen de error:

$$
mer = \frac{me}{\hat{\theta}}
$$

Calculamos el margen de error, margen de error relativo, error estándar y los límites del intervalo de confianza del 95%.

```{r}
conf <- 0.95
df_ValoresFijados <- df_ValoresFijados %>%
                    mutate(pobreza_me =  qnorm(1-(1-conf)/2) * pobreza_cve * pobreza_prop, 
                           pobreza_mer = pobreza_me / pobreza_prop,
                           pobreza_se = pobreza_cve * pobreza_prop,
                           pobreza_LI = pobreza_prop - pobreza_me,
                           pobreza_LS = pobreza_prop + pobreza_me,
                           pobrezaExtr_me =  qnorm(1-(1-conf)/2) * pobrezaExtr_cve * pobrezaExtr_prop, 
                           pobrezaExtr_mer = pobrezaExtr_me / pobrezaExtr_prop,
                           pobrezaExtr_se = pobrezaExtr_cve * pobrezaExtr_prop,
                           pobrezaExtr_LI = pobrezaExtr_prop - pobrezaExtr_me,
                           pobrezaExtr_LS = pobrezaExtr_prop + pobrezaExtr_me,
                           NBI_me =  qnorm(1-(1-conf)/2) * NBI_cve * NBI_prop, 
                           NBI_mer = NBI_me / NBI_prop,
                           NBI_se = NBI_cve * NBI_prop,
                           NBI_LI = NBI_prop - NBI_me,
                           NBI_LS = NBI_prop + NBI_me,
              tasa_desocupacion_me =  qnorm(1-(1-conf)/2) * tasa_desocupacion_cve * tasa_desocupacion_prop, 
              tasa_desocupacion_mer = tasa_desocupacion_me / tasa_desocupacion_prop,
              tasa_desocupacion_se = tasa_desocupacion_cve * tasa_desocupacion_prop,
              tasa_desocupacion_LI = tasa_desocupacion_prop - tasa_desocupacion_me,
              tasa_desocupacion_LS = tasa_desocupacion_prop + tasa_desocupacion_me,
              tasa_ocupacion_me =  qnorm(1-(1-conf)/2) * tasa_ocupacion_cve * tasa_ocupacion_prop, 
              tasa_ocupacion_mer = tasa_ocupacion_me / tasa_ocupacion_prop,
              tasa_ocupacion_se = tasa_ocupacion_cve * tasa_ocupacion_prop,
              tasa_ocupacion_LI = tasa_ocupacion_prop - tasa_ocupacion_me,
              tasa_ocupacion_LS = tasa_ocupacion_prop + tasa_ocupacion_me,
              tasa_participacion_me =  qnorm(1-(1-conf)/2) * tasa_participacion_cve * tasa_participacion_prop, 
              tasa_participacion_mer = tasa_participacion_me / tasa_participacion_prop,
              tasa_participacion_se = tasa_participacion_cve * tasa_participacion_prop,
              tasa_participacion_LI = tasa_participacion_prop - tasa_participacion_me,
              tasa_participacion_LS = tasa_participacion_prop + tasa_participacion_me) %>%
                    select(Area,
pobreza_prop, pobreza_se, pobreza_me, pobreza_mer, pobreza_cve, pobreza_LI, pobreza_LS,
pobrezaExtr_prop, pobrezaExtr_se, pobrezaExtr_me, pobrezaExtr_mer, pobrezaExtr_cve, pobrezaExtr_LI, pobrezaExtr_LS,
NBI_prop, NBI_se, NBI_me, NBI_mer, NBI_cve, NBI_LI, NBI_LS,
tasa_desocupacion_prop, tasa_desocupacion_se, tasa_desocupacion_me, tasa_desocupacion_mer, tasa_desocupacion_cve, tasa_desocupacion_LI, tasa_desocupacion_LS,
tasa_ocupacion_prop, tasa_ocupacion_se, tasa_ocupacion_me, tasa_ocupacion_mer, tasa_ocupacion_cve, tasa_ocupacion_LI, tasa_ocupacion_LS,
tasa_participacion_prop, tasa_participacion_se, tasa_participacion_me, tasa_participacion_mer, tasa_participacion_cve, tasa_participacion_LI, tasa_participacion_LS)

df_ValoresFijados %>% flextable()
```


## 5.3. Generación de las tablas de muestreo

Para identificar los indicadores del área urbano y rural calculamos un vector lógico que permite filtrar rapidamente la información:

```{r}
indice_Urbana <- which(df_ValoresFijados$Area == "Urbana")
indice_Rural <- which(df_ValoresFijados$Area == "Rural")
```

Calculamos la tabla de muestreo para la pobreza monetaria:


```{r}
tablaMuestreo_pobreza_Urbana <- ss4HHSp(N = df_ParamGenerales$N[indice_Urbana],
M = df_ParamGenerales$M[indice_Urbana], 
r = df_ParamGenerales$r_pobreza[indice_Urbana], 
b = df_ParamGenerales$b[indice_Urbana],
rho = df_rho$`rho pobreza.`[df_rho$Area == "Urbana"],
P = df_ValoresFijados$pobreza_prop[indice_Urbana], 
delta = df_ValoresFijados$pobreza_mer[indice_Urbana],
conf = 0.95, m = 5:15)

tablaMuestreo_pobreza_Rural <- ss4HHSp(N = df_ParamGenerales$N[indice_Rural],
M = df_ParamGenerales$M[indice_Rural], 
r = df_ParamGenerales$r_pobreza[indice_Rural], 
b = df_ParamGenerales$b[indice_Rural],
rho = df_rho$`rho pobreza.`[df_rho$Area == "Rural"],
P = df_ValoresFijados$pobreza_prop[indice_Rural], 
delta = df_ValoresFijados$pobreza_mer[indice_Rural],
conf = 0.95, m = 5:15)
```



Calculamos la tabla de muestreo para la pobreza extrema:

```{r}
tablaMuestreo_pobrezaExtr_Urbana <- ss4HHSp(N = df_ParamGenerales$N[indice_Urbana],
M = df_ParamGenerales$M[indice_Urbana], 
r = df_ParamGenerales$r_pobrezaExtr[indice_Urbana], 
b = df_ParamGenerales$b[indice_Urbana],
rho = df_rho$`rho pobreza extrema`[df_rho$Area == "Urbana"],
P = df_ValoresFijados$pobrezaExtr_prop[indice_Urbana], 
delta = df_ValoresFijados$pobrezaExtr_mer[indice_Urbana],
conf = 0.95, m = 5:15)

tablaMuestreo_pobrezaExtr_Rural <- ss4HHSp(N = df_ParamGenerales$N[indice_Rural],
M = df_ParamGenerales$M[indice_Rural], 
r = df_ParamGenerales$r_pobrezaExtr[indice_Rural], 
b = df_ParamGenerales$b[indice_Rural],
rho = df_rho$`rho pobreza extrema`[df_rho$Area == "Rural"],
P = df_ValoresFijados$pobrezaExtr_prop[indice_Rural], 
delta = df_ValoresFijados$pobrezaExtr_mer[indice_Rural],
conf = 0.95, m = 5:15)
```


Calculamos la tabla de muestreo para el NBI:

```{r}
tablaMuestreo_NBI_Urbana <- ss4HHSp(N = df_ParamGenerales$N[indice_Urbana],
M = df_ParamGenerales$M[indice_Urbana], 
r = df_ParamGenerales$r_NBI[indice_Urbana], 
b = df_ParamGenerales$b[indice_Urbana],
rho = df_rho$`rho NBI`[df_rho$Area == "Urbana"],
P = df_ValoresFijados$NBI_prop[indice_Urbana], 
delta = df_ValoresFijados$NBI_mer[indice_Urbana],
conf = 0.95, m = 5:15)

tablaMuestreo_NBI_Rural <- ss4HHSp(N = df_ParamGenerales$N[indice_Rural],
M = df_ParamGenerales$M[indice_Rural], 
r = df_ParamGenerales$r_NBI[indice_Rural], 
b = df_ParamGenerales$b[indice_Rural],
rho = df_rho$`rho NBI`[df_rho$Area == "Rural"],
P = df_ValoresFijados$NBI_prop[indice_Rural], 
delta = df_ValoresFijados$NBI_mer[indice_Rural],
conf = 0.95, m = 5:15)
```


Calculamos la tabla de muestreo para la tasa de desocupación:


```{r}
tablaMuestreo_tasa_desocupacion_Urbana <- ss4HHSp(N = df_ParamGenerales$N[indice_Urbana],
M = df_ParamGenerales$M[indice_Urbana], 
r = df_ParamGenerales$r_tasa_desocupacion[indice_Urbana], 
b = df_ParamGenerales$b[indice_Urbana],
rho = df_rho$`rho Tasa desocupación`[df_rho$Area == "Urbana"],
P = df_ValoresFijados$tasa_desocupacion_prop[indice_Urbana], 
delta = df_ValoresFijados$tasa_desocupacion_mer[indice_Urbana],
conf = 0.95, m = 5:15)

tablaMuestreo_tasa_desocupacion_Rural <- ss4HHSp(N = df_ParamGenerales$N[indice_Rural],
M = df_ParamGenerales$M[indice_Rural], 
r = df_ParamGenerales$r_tasa_desocupacion[indice_Rural], 
b = df_ParamGenerales$b[indice_Rural],
rho = df_rho$`rho Tasa desocupación`[df_rho$Area == "Rural"],
P = df_ValoresFijados$tasa_desocupacion_prop[indice_Rural], 
delta = df_ValoresFijados$tasa_desocupacion_mer[indice_Rural],
conf = 0.95, m = 5:15)
```



Calculamos la tabla de muestreo para la tasa de ocupación:


```{r}
tablaMuestreo_tasa_ocupacion_Urbana <- ss4HHSp(N = df_ParamGenerales$N[indice_Urbana],
M = df_ParamGenerales$M[indice_Urbana], 
r = df_ParamGenerales$r_tasa_ocupacion[indice_Urbana], 
b = df_ParamGenerales$b[indice_Urbana],
rho = df_rho$`rho Tasa ocupación`[df_rho$Area == "Urbana"],
P = df_ValoresFijados$tasa_ocupacion_prop[indice_Urbana], 
delta = df_ValoresFijados$tasa_ocupacion_mer[indice_Urbana],
conf = 0.95, m = 5:15)

tablaMuestreo_tasa_ocupacion_Rural <- ss4HHSp(N = df_ParamGenerales$N[indice_Rural],
M = df_ParamGenerales$M[indice_Rural], 
r = df_ParamGenerales$r_tasa_ocupacion[indice_Rural], 
b = df_ParamGenerales$b[indice_Rural],
rho = df_rho$`rho Tasa ocupación`[df_rho$Area == "Rural"],
P = df_ValoresFijados$tasa_ocupacion_prop[indice_Rural], 
delta = df_ValoresFijados$tasa_ocupacion_mer[indice_Rural],
conf = 0.95, m = 5:15)
```




```{r}
tablaMuestreo_tasa_participacion_Urbana <- ss4HHSp(N = df_ParamGenerales$N[indice_Urbana],
M = df_ParamGenerales$M[indice_Urbana], 
r = df_ParamGenerales$r_tasa_participacion[indice_Urbana], 
b = df_ParamGenerales$b[indice_Urbana],
rho = df_rho$`rho tasa de participación`[df_rho$Area == "Urbana"],
P = df_ValoresFijados$tasa_participacion_prop[indice_Urbana], 
delta = df_ValoresFijados$tasa_participacion_mer[indice_Urbana],
conf = 0.95, m = 5:15)

tablaMuestreo_tasa_participacion_Rural <- ss4HHSp(N = df_ParamGenerales$N[indice_Rural],
M = df_ParamGenerales$M[indice_Rural], 
r = df_ParamGenerales$r_tasa_participacion[indice_Rural], 
b = df_ParamGenerales$b[indice_Rural],
rho = df_rho$`rho tasa de participación`[df_rho$Area == "Rural"],
P = df_ValoresFijados$tasa_participacion_prop[indice_Rural], 
delta = df_ValoresFijados$tasa_participacion_mer[indice_Rural],
conf = 0.95, m = 5:15)
```



## 5.4. Integración de tablas nacionales

Integrarlas las  tablas de muestreo (Urbana y rural) en una nacional, para lograr lo anterior desarrollamos una función que podamos aplicar.

```{r}
# tabla_muestreo_urbano <- tablaMuestreo_pobreza_Urbana
# tabla_muestreo_rural <- tablaMuestreo_pobreza_Rural
#  str_indicador = "pobreza_prop" 
#  str_cve = "pobreza_cve"
#  str_N = "N"

# tabla_muestreo_urbano = tablaMuestreo_tasa_desocupacion_Urbana;
#                        tabla_muestreo_rural = tablaMuestreo_tasa_desocupacion_Rural;
#                        str_indicador = "tasa_desocupacion_prop";
#                        str_cve = "tasa_desocupacion_cve";
#                        str_N = "N_activos";

f_CompletarTablaNacional <- function(tabla_muestreo_urbano, tabla_muestreo_rural, str_indicador, str_cve, str_N){
tablaMuestreo_nacional <- tabla_muestreo_urbano


tablaMuestreo_nacional$PSUinSample <- tabla_muestreo_urbano$PSUinSample + 
                                              tabla_muestreo_rural$PSUinSample

tablaMuestreo_nacional$HouseholdsInSample  <- tabla_muestreo_urbano$HouseholdsInSample + 
                                              tabla_muestreo_rural$HouseholdsInSample

tablaMuestreo_nacional$PersonsInSample  <- tabla_muestreo_urbano$PersonsInSample + 
                                              tabla_muestreo_rural$PersonsInSample

tablaMuestreo_nacional$PersonsPerPSU <- tablaMuestreo_nacional$PersonsInSample /  
                                        tablaMuestreo_nacional$PSUinSample  


V_MAS_Urbana <- ((df_ValoresFijados[[str_cve]][1] * df_ValoresFijados[[str_indicador]][1])^2) / 
                         tabla_muestreo_urbano$DEFF

V_MAS_Rural <- ((df_ValoresFijados[[str_cve]][2] * df_ValoresFijados[[str_indicador]][2])^2) / 
                         tabla_muestreo_rural$DEFF


V_nacional <- ((df_ValoresFijados[[str_cve]][1] * df_ValoresFijados[[str_indicador]][1])^2) + ((df_ValoresFijados[[str_cve]][2] * df_ValoresFijados[[str_indicador]][2])^2) 

indicador_nacional = (df_estima_indicadores[[str_N]][1] * df_ValoresFijados[[str_indicador]][1] +
               df_estima_indicadores[[str_N]][2] * df_ValoresFijados[[str_indicador]][2]) / 
               (df_estima_indicadores[[str_N]][1] + df_estima_indicadores[[str_N]][2])
deff_nacional <- V_nacional / (V_MAS_Urbana + V_MAS_Rural)

medidas_error_nacional <- samplesize4surveys::e4p(N = df_ParamGenerales$N[1] + df_ParamGenerales$N[2], n = tablaMuestreo_nacional$PersonsInSample, 
                        P = indicador_nacional, DEFF = deff_nacional)


tablaMuestreo_nacional$DEFF <- deff_nacional

tablaMuestreo_nacional$cve <- round(medidas_error_nacional$cve / 100, 3)
tablaMuestreo_nacional$M.E. <- round(medidas_error_nacional$Margin_of_error / 100, 3)
tablaMuestreo_nacional$M.E.R <- round(medidas_error_nacional$Relative_Margin_of_error / 100, 3)

#  str_indicador = "pobreza_prop" 
str_prefijo_var <- gsub("_prop", "", str_indicador)
tabla_muestreo_urbano$cve <- round(df_ValoresFijados[[paste0(str_prefijo_var, "_cve")]][1], 3)
tabla_muestreo_urbano$M.E. <- round(df_ValoresFijados[[paste0(str_prefijo_var, "_me")]][1], 3)
tabla_muestreo_urbano$M.E.R <- round(df_ValoresFijados[[paste0(str_prefijo_var, "_mer")]][1], 3)

tabla_muestreo_rural$cve <-  round(df_ValoresFijados[[paste0(str_prefijo_var, "_cve")]][2], 3)
tabla_muestreo_rural$M.E. <- round(df_ValoresFijados[[paste0(str_prefijo_var, "_me")]][2], 3)
tabla_muestreo_rural$M.E.R <- round(df_ValoresFijados[[paste0(str_prefijo_var, "_mer")]][2], 3)
resultado <- list(tablaMuestreo_nacional, tabla_muestreo_urbano, tabla_muestreo_rural)
names(resultado) <- c("tabla_Muestreo_nacional", "tabla_Muestreo_urbano", "tabla_Muestreo_rural")
resultado
}
```

Completamos las tablas de muestreo nacional:

```{r}
tablaMuestreo_pobreza <- f_CompletarTablaNacional(tabla_muestreo_urbano = tablaMuestreo_pobreza_Urbana,
                       tabla_muestreo_rural = tablaMuestreo_pobreza_Rural,
                       str_indicador = "pobreza_prop",
                       str_cve = "pobreza_cve", 
                       str_N = "N")

tablaMuestreo_pobreza_Nacional <- tablaMuestreo_pobreza$tabla_Muestreo_nacional
tablaMuestreo_pobreza_Urbana <- tablaMuestreo_pobreza$tabla_Muestreo_urbano
tablaMuestreo_pobreza_Rural <- tablaMuestreo_pobreza$tabla_Muestreo_rural

tablaMuestreo_pobrezaExtr <- f_CompletarTablaNacional(tabla_muestreo_urbano = tablaMuestreo_pobrezaExtr_Urbana,
                       tabla_muestreo_rural = tablaMuestreo_pobrezaExtr_Rural,
                       str_indicador = "pobrezaExtr_prop",
                       str_cve = "pobrezaExtr_cve", 
                       str_N = "N")

tablaMuestreo_pobrezaExtr_Nacional <- tablaMuestreo_pobrezaExtr$tabla_Muestreo_nacional
tablaMuestreo_pobrezaExtr_Urbana <- tablaMuestreo_pobrezaExtr$tabla_Muestreo_urbano
tablaMuestreo_pobrezaExtr_Rural <- tablaMuestreo_pobrezaExtr$tabla_Muestreo_rural




tablaMuestreo_NBI <- f_CompletarTablaNacional(tabla_muestreo_urbano = tablaMuestreo_NBI_Urbana,
                       tabla_muestreo_rural = tablaMuestreo_NBI_Rural,
                       str_indicador = "NBI_prop",
                       str_cve = "NBI_cve", 
                       str_N = "N")

tablaMuestreo_NBI_Nacional <- tablaMuestreo_NBI$tabla_Muestreo_nacional
tablaMuestreo_NBI_Urbana <- tablaMuestreo_NBI$tabla_Muestreo_urbano
tablaMuestreo_NBI_Rural <- tablaMuestreo_NBI$tabla_Muestreo_rural


tablaMuestreo_tasa_desocupacion <- f_CompletarTablaNacional(tabla_muestreo_urbano = tablaMuestreo_tasa_desocupacion_Urbana,
                       tabla_muestreo_rural = tablaMuestreo_tasa_desocupacion_Rural,
                       str_indicador = "tasa_desocupacion_prop",
                       str_cve = "tasa_desocupacion_cve", 
                       str_N = "N_activos")


tablaMuestreo_tasa_desocupacion_Nacional <- tablaMuestreo_tasa_desocupacion$tabla_Muestreo_nacional
tablaMuestreo_tasa_desocupacion_Urbana <- tablaMuestreo_tasa_desocupacion$tabla_Muestreo_urbano
tablaMuestreo_tasa_desocupacion_Rural <- tablaMuestreo_tasa_desocupacion$tabla_Muestreo_rural


tablaMuestreo_tasa_ocupacion <- f_CompletarTablaNacional(tabla_muestreo_urbano = tablaMuestreo_tasa_ocupacion_Urbana,
                       tabla_muestreo_rural = tablaMuestreo_tasa_ocupacion_Rural,
                       str_indicador = "tasa_ocupacion_prop",
                       str_cve = "tasa_ocupacion_cve", 
                       str_N = "N_activos")

tablaMuestreo_tasa_ocupacion_Nacional <- tablaMuestreo_tasa_ocupacion$tabla_Muestreo_nacional
tablaMuestreo_tasa_ocupacion_Urbana <- tablaMuestreo_tasa_ocupacion$tabla_Muestreo_urbano
tablaMuestreo_tasa_ocupacion_Rural <- tablaMuestreo_tasa_ocupacion$tabla_Muestreo_rural


tablaMuestreo_tasa_participacion <- f_CompletarTablaNacional(tabla_muestreo_urbano = tablaMuestreo_tasa_participacion_Urbana,
                       tabla_muestreo_rural = tablaMuestreo_tasa_participacion_Rural,
                       str_indicador = "tasa_participacion_prop",
                       str_cve = "tasa_participacion_cve", 
                       str_N = "N_activos")

tablaMuestreo_tasa_participacion_Nacional <- tablaMuestreo_tasa_participacion$tabla_Muestreo_nacional
tablaMuestreo_tasa_participacion_Urbana <- tablaMuestreo_tasa_participacion$tabla_Muestreo_urbano
tablaMuestreo_tasa_participacion_Rural <- tablaMuestreo_tasa_participacion$tabla_Muestreo_rural
```
Imprimimos una por una las tablas resultantes a nivel nacional, para todos los indicadores de interés: pobreza, pobreza extrema, NBI y desocupación. 

```{r}
tablaMuestreo_pobreza_Nacional %>% flextable()
```

```{r}
tablaMuestreo_pobrezaExtr_Nacional %>% flextable()
```


```{r}
tablaMuestreo_NBI_Nacional %>% flextable()
```


```{r}
tablaMuestreo_tasa_desocupacion_Nacional %>% flextable()
```

```{r}
tablaMuestreo_tasa_ocupacion_Nacional %>% flextable()
```


```{r}
tablaMuestreo_tasa_participacion_Nacional %>% flextable()
```



# 6. Integración de costos a las tablas de muestreo


```{r}
f_costos <- function(tablaMuestreo_Urbana, tablaMuestreo_Rural, tablaMuestreo_Nacional){
tablaMuestreo_Urbana$Costos_UPM <- modelo_urbano$coefficients[1] + 
tablaMuestreo_Urbana$HouseholdsPerPSU * modelo_urbano$coefficients[2] + 
tablaMuestreo_Urbana$PSUinSample * modelo_urbano$coefficients[3] %>% round()

tablaMuestreo_Urbana$Costos_Total <- tablaMuestreo_Urbana$Costos_UPM * tablaMuestreo_Urbana$PSUinSample %>% round()


tablaMuestreo_Rural$Costos_UPM <- modelo_rural$coefficients[1] + 
tablaMuestreo_Rural$HouseholdsPerPSU * modelo_rural$coefficients[2] + 
tablaMuestreo_Rural$PSUinSample * modelo_rural$coefficients[3] %>% round()

tablaMuestreo_Rural$Costos_Total <- tablaMuestreo_Rural$Costos_UPM * tablaMuestreo_Rural$PSUinSample %>% round()



tablaMuestreo_Nacional$Costos_Total <- tablaMuestreo_Urbana$Costos_Total + 
                                             tablaMuestreo_Rural$Costos_Total %>% round()

tablaMuestreo_Nacional$Costos_UPM <- tablaMuestreo_Nacional$Costos_Total /  tablaMuestreo_Nacional$PSUinSample %>% round()

tablaMuestreo_Nacional <- tablaMuestreo_Nacional %>% 
  relocate(Costos_Total, .after = last_col())
resultado <- list(tablaMuestreo_Nacional, tablaMuestreo_Urbana, tablaMuestreo_Rural)
names(resultado) <- c("tablaMuestreo_Nacional", "tablaMuestreo_Urbana", "tablaMuestreo_Rural")
resultado
}
```


Calculamos los costos que conlleva realizar una UPM para la tasa de desocupación:

```{r}
tablaMuestreo_tasa_desocupacion_Urbana <-  f_costos(tablaMuestreo_Urbana = tablaMuestreo_tasa_desocupacion_Urbana, 
         tablaMuestreo_Rural = tablaMuestreo_tasa_desocupacion_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_tasa_desocupacion_Nacional)$tablaMuestreo_Urbana

tablaMuestreo_tasa_desocupacion_Rural <- f_costos(tablaMuestreo_Urbana = tablaMuestreo_tasa_desocupacion_Urbana, 
         tablaMuestreo_Rural = tablaMuestreo_tasa_desocupacion_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_tasa_desocupacion_Nacional)$tablaMuestreo_Rural

tablaMuestreo_tasa_desocupacion_Nacional <- f_costos(tablaMuestreo_Urbana = tablaMuestreo_tasa_desocupacion_Urbana, 
         tablaMuestreo_Rural = tablaMuestreo_tasa_desocupacion_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_tasa_desocupacion_Nacional)$tablaMuestreo_Nacional
```



Calculamos los costos que conlleva realizar una UPM para la tasa de ocupación:

```{r}
tablaMuestreo_tasa_ocupacion_Urbana <-  f_costos(tablaMuestreo_Urbana = tablaMuestreo_tasa_ocupacion_Urbana, 
         tablaMuestreo_Rural = tablaMuestreo_tasa_ocupacion_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_tasa_ocupacion_Nacional)$tablaMuestreo_Urbana

tablaMuestreo_tasa_ocupacion_Rural <- f_costos(tablaMuestreo_Urbana = tablaMuestreo_tasa_ocupacion_Urbana, 
         tablaMuestreo_Rural = tablaMuestreo_tasa_ocupacion_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_tasa_ocupacion_Nacional)$tablaMuestreo_Rural

tablaMuestreo_tasa_ocupacion_Nacional <- f_costos(tablaMuestreo_Urbana = tablaMuestreo_tasa_ocupacion_Urbana, 
         tablaMuestreo_Rural = tablaMuestreo_tasa_ocupacion_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_tasa_ocupacion_Nacional)$tablaMuestreo_Nacional
```



```{r}
tablaMuestreo_tasa_participacion_Urbana <-  f_costos(tablaMuestreo_Urbana = tablaMuestreo_tasa_participacion_Urbana, 
         tablaMuestreo_Rural = tablaMuestreo_tasa_participacion_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_tasa_participacion_Nacional)$tablaMuestreo_Urbana

tablaMuestreo_tasa_participacion_Rural <- f_costos(tablaMuestreo_Urbana = tablaMuestreo_tasa_participacion_Urbana, 
         tablaMuestreo_Rural = tablaMuestreo_tasa_participacion_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_tasa_participacion_Nacional)$tablaMuestreo_Rural

tablaMuestreo_tasa_participacion_Nacional <- f_costos(tablaMuestreo_Urbana = tablaMuestreo_tasa_participacion_Urbana, 
         tablaMuestreo_Rural = tablaMuestreo_tasa_participacion_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_tasa_participacion_Nacional)$tablaMuestreo_Nacional
```



```{r}
tablaMuestreo_pobreza_Urbana <- f_costos(tablaMuestreo_Urbana = tablaMuestreo_pobreza_Urbana, 
         tablaMuestreo_Rural = tablaMuestreo_pobreza_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_pobreza_Nacional)$tablaMuestreo_Urbana

tablaMuestreo_pobreza_Rural <- f_costos(tablaMuestreo_Urbana = tablaMuestreo_pobreza_Urbana, 
         tablaMuestreo_Rural = tablaMuestreo_pobreza_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_pobreza_Nacional)$tablaMuestreo_Rural

tablaMuestreo_pobreza_Nacional <- f_costos(tablaMuestreo_Urbana = tablaMuestreo_pobreza_Urbana,          tablaMuestreo_Rural = tablaMuestreo_pobreza_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_pobreza_Nacional)$tablaMuestreo_Nacional

```



```{r}
tablaMuestreo_pobrezaExtr_Urbana <- f_costos(tablaMuestreo_Urbana = tablaMuestreo_pobrezaExtr_Urbana, 
         tablaMuestreo_Rural = tablaMuestreo_pobrezaExtr_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_pobrezaExtr_Nacional)$tablaMuestreo_Urbana

tablaMuestreo_pobrezaExtr_Rural <- f_costos(tablaMuestreo_Urbana = tablaMuestreo_pobrezaExtr_Urbana, 
         tablaMuestreo_Rural = tablaMuestreo_pobrezaExtr_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_pobrezaExtr_Nacional)$tablaMuestreo_Rural

tablaMuestreo_pobrezaExtr_Nacional <- f_costos(tablaMuestreo_Urbana = tablaMuestreo_pobrezaExtr_Urbana,          tablaMuestreo_Rural = tablaMuestreo_pobrezaExtr_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_pobrezaExtr_Nacional)$tablaMuestreo_Nacional
```



```{r}
tablaMuestreo_NBI_Urbana <- f_costos(tablaMuestreo_Urbana = tablaMuestreo_NBI_Urbana, 
         tablaMuestreo_Rural = tablaMuestreo_NBI_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_NBI_Nacional)$tablaMuestreo_Urbana

tablaMuestreo_NBI_Rural <- f_costos(tablaMuestreo_Urbana = tablaMuestreo_NBI_Urbana, 
         tablaMuestreo_Rural = tablaMuestreo_NBI_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_NBI_Nacional)$tablaMuestreo_Rural

tablaMuestreo_NBI_Nacional <- f_costos(tablaMuestreo_Urbana = tablaMuestreo_NBI_Urbana,          tablaMuestreo_Rural = tablaMuestreo_NBI_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_NBI_Nacional)$tablaMuestreo_Nacional
```



# 7. Exportación de resultados

```{r}
lista_resultados_tasa_desocupacion <- list(tablaMuestreo_tasa_desocupacion_Urbana, tablaMuestreo_tasa_desocupacion_Rural, tablaMuestreo_tasa_desocupacion_Nacional)
names(lista_resultados_tasa_desocupacion) <- c("tablaMuestreo_tasa_desocupacion_Urbana", "tablaMuestreo_tasa_desocupacion_Rural", "tablaMuestreo_tasa_desocupacion_Nacional")

lista_resultados_tasa_ocupacion <- list(tablaMuestreo_tasa_ocupacion_Urbana, tablaMuestreo_tasa_ocupacion_Rural, tablaMuestreo_tasa_ocupacion_Nacional)
names(lista_resultados_tasa_ocupacion) <- c("tablaMuestreo_tasa_ocupacion_Urbana", "tablaMuestreo_tasa_ocupacion_Rural", "tablaMuestreo_tasa_ocupacion_Nacional")


lista_resultados_tasa_participacion <- list(tablaMuestreo_tasa_participacion_Urbana, tablaMuestreo_tasa_participacion_Rural, tablaMuestreo_tasa_participacion_Nacional)
names(lista_resultados_tasa_participacion) <- c("tablaMuestreo_tasa_participacion_Urbana", "tablaMuestreo_tasa_participacion_Rural", "tablaMuestreo_tasa_participacion_Nacional")

lista_resultados_pobreza <- list(tablaMuestreo_pobreza_Urbana, tablaMuestreo_pobreza_Rural, tablaMuestreo_pobreza_Nacional)
names(lista_resultados_pobreza) <- c("tablaMuestreo_pobreza_Urbana", "tablaMuestreo_pobreza_Rural", "tablaMuestreo_pobreza_Nacional")

lista_resultados_pobrezaExtr <- list(tablaMuestreo_pobrezaExtr_Urbana, tablaMuestreo_pobrezaExtr_Rural, tablaMuestreo_pobrezaExtr_Nacional)
names(lista_resultados_pobrezaExtr) <- c("tablaMuestreo_pobrezaExtr_Urbana", "tablaMuestreo_pobrezaExtr_Rural", "tablaMuestreo_pobrezaExtr_Nacional")

lista_resultados_NBI <- list(tablaMuestreo_NBI_Urbana, tablaMuestreo_NBI_Rural, tablaMuestreo_NBI_Nacional)
names(lista_resultados_NBI) <- c("tablaMuestreo_NBI_Urbana", "tablaMuestreo_NBI_Rural", "tablaMuestreo_NBI_Nacional")

lista_nacional <- list(tablaMuestreo_tasa_desocupacion_Nacional,
                       tablaMuestreo_tasa_ocupacion_Nacional,
                       tablaMuestreo_tasa_participacion_Nacional,
                       tablaMuestreo_pobreza_Nacional,
                       tablaMuestreo_pobrezaExtr_Nacional, tablaMuestreo_NBI_Nacional)
names(lista_nacional) <- c("tablaMuestreo_tasa_desocupacion_Nacional",
                           "tablaMuestreo_tasa_ocupacion_Nacional",
                           "tablaMuestreo_tasa_participacion_Nacional",
                           "tablaMuestreo_pobreza_Nacional",
                       "tablaMuestreo_pobrezaExtr_Nacional",  
                       "tablaMuestreo_NBI_Nacional")
```

Exportamos los resultados:

```{r}

names(lista_resultados_tasa_desocupacion) <- c("Urbana", "Rural", "Nacional")
names(lista_resultados_tasa_ocupacion) <- c("Urbana", "Rural", "Nacional")
names(lista_resultados_tasa_participacion) <- c("Urbana", "Rural", "Nacional")
names(lista_resultados_pobreza) <- c("Urbana", "Rural", "Nacional")
names(lista_resultados_pobrezaExtr) <- c("Urbana", "Rural", "Nacional")
names(lista_resultados_NBI) <- c("Urbana", "Rural", "Nacional")
names(lista_nacional) <- c("Desoc", "Ocup", "Particip", "Pobreza", "PobExtr", 
                           "NBI")

setwd("../output")
write_xlsx(lista_resultados_tasa_desocupacion, "resultados_desocupacion.xlsx")
write_xlsx(lista_resultados_tasa_ocupacion, "resultados_tasa_ocupacion.xlsx")
write_xlsx(lista_resultados_tasa_participacion, "resultados_tasa_participacion.xlsx")
write_xlsx(lista_resultados_pobreza, "resultados_pobreza.xlsx")
write_xlsx(lista_resultados_pobrezaExtr, "resultados_pobrezaExtr.xlsx")
write_xlsx(lista_resultados_NBI, "resultados_NBI.xlsx")
write_xlsx(lista_nacional, "resultados_nacional.xlsx")
```

