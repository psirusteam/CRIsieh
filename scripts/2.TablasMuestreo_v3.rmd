---
title: "Tamaño de muestra Costa Rica"
author: "José Fernando Zea - Andrés Gutiérrez"
date: '2022-06-09'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1. Carga e instalación de librerías

```{r, warning=FALSE, message=FALSE}
# install.packages(pacman)
is_pacman <- require(pacman)
if(!is_pacman) install.packages("pacman") else library(pacman)
library(pacman)
p_load(haven, labelled, srvyr, samplesize4surveys, flextable, dplyr, arrow, writexl, tidyr)
options(survey.adjust.domain.lonely=TRUE)
options(survey.lonely.psu="adjust")
```


# 2. Lectura de datos y preprocesamiento

Cargamos el modelo de costos para las tablas de muestreo:

```{r, warning=FALSE, message=FALSE}
setwd("../output")
load( "modelo_Costos_V2.Rdata")
```

Se exporta el censo poblacional con el proposito de conocer el número de UPMs:

```{r, warning=FALSE, message=FALSE}
setwd("../data/")
df_censo <- open_dataset("parquet")
```

También se exporta encuesta de hogares del año 2020, seleccionaremos los insumos necesarios para calcular el tamaño de muestra para las encuestas multipropositos en el período intercensal. Se utilizarán como indicadores trazadoras la tasa de desocación, la pobreza monetaria y el índice de pobreza multidimensional: 


```{r, warning=FALSE, message=FALSE}
setwd("../data/cri20n1")
df_encuesta <- read_dta("cri20n1.dta")
df_encuesta %<>% select(id_vivienda,id_hogar, id_hogar_inec, id_pers, 
                                      diseno_muestra, region, areageo, areageo2, upm, 
                                      factorex, condact3, pobreza, ipm_pobreza)
```

El identificador de las encuestas está conformado por la concatenación del identificador del hogar y la persona:

```{r, warning=FALSE, message=FALSE}
# prueba id: id hogar  y persona
df_encuesta %<>% mutate(id_hogper = paste0(id_hogar, "_", id_pers))
test_duplicados <- table(duplicated(df_encuesta$id_hogper))
```


Se utilizará como estrato de diseño la combinación de región y área:

```{r, warning=FALSE, message=FALSE}
df_encuesta %<>% mutate(region_area = paste0(region, "_", areageo))
```

Por otro lado crearmos variables dummies para la pobreza monetaria no extrema y la pobreza monetaria extrema:

```{r, warning=FALSE, message=FALSE}
df_encuesta %<>% mutate(pobreza_monet = ifelse(pobreza %in% 1:2, 1, 0),
                        pobreza_monet_extrema = ifelse(pobreza %in% 1, 1, 0))
```


Se construye la variable dummy para los desocupados:

```{r, warning=FALSE, message=FALSE}
df_encuesta %<>% mutate(ocupados = ifelse(condact3 == 1, 1, ifelse(condact3 == -1, NA, 0)),
                        desocupados = ifelse(condact3 == 2, 1, ifelse(condact3 == -1, NA, 0)),
                        inactivos = ifelse(condact3 == 3, 1, ifelse(condact3 == -1, NA, 0)),
                        activos = ocupados + desocupados)
```


Calculamos el número de UPM's en el área urbana y rural, estas estadísticas son necesarios para calcular las tablas de muestreo. Para esto se hará uso del censo de población de Costa Rica del año 2011:

```{r, warning=FALSE, message=FALSE}
# UPM 5.251 no existe 
con_numUpmXzona <- df_censo %>% group_by(ID_ZONA, UPM2) %>% summarise(num_personas = n()) %>% 
  group_by(ID_ZONA) %>% summarise(num_upms = n()) %>% collect()
con_numUpmXzona %>% flextable()
```


# 3. Deficinión diseño muestral y estimación de parámetros

Definimos el diseño muestral detallando las UPM, estrato y factor de expansión, utilizamos para aproximar el diseño muestral la técnica del último conglomerado:

```{r, warning=FALSE, message=FALSE}
df_encuesta$id <- 1:nrow(df_encuesta)
df_encuesta$unos <- 1

diseno_pobreza <- df_encuesta %>% as_survey_design(ids = upm,
                                        strata = region_area,  
                                        weights = factorex, nest = T)
   
df_estima_indicadores <- diseno_pobreza %>% group_by(areageo2) %>%
  summarize(pobreza = survey_mean(pobreza_monet, na.rm = T, deff = T),
            pobrezaExtr = survey_mean(pobreza_monet_extrema, na.rm = T, deff = T),
            IPM = survey_mean(ipm_pobreza, na.rm = T, deff = T),
            Desoc = survey_ratio(desocupados, activos, na.rm = T, deff = T),
            N = survey_total(unos),
            N_activos = survey_total(activos, na.rm = T, deff = F)) 

names(df_estima_indicadores)[names(df_estima_indicadores) == "pobreza"] <- "pobreza_prop"
names(df_estima_indicadores)[names(df_estima_indicadores) == "pobrezaExtr"] <- "pobrezaExtr_prop"
names(df_estima_indicadores)[names(df_estima_indicadores) == "IPM"] <- "IPM_prop"
names(df_estima_indicadores)[names(df_estima_indicadores) == "Desoc"] <- "Desoc_prop"
```


A continuación se editan los resultados anteriormente obtenidos:

```{r, warning=FALSE, message=FALSE}
conf <- 0.95
df_estima_indicadores <- df_estima_indicadores %>%
                    mutate(Area = names(val_labels(areageo2)),
                           pobreza_prop = round(pobreza_prop, 2), 
                           pobreza_se = round(pobreza_se, 4),
                           pobreza_me = round(qnorm(1-(1-conf)/2) * pobreza_se, 4),
                           pobreza_mer = round(pobreza_me / pobreza_prop, 4),
                           pobreza_cve = round(100 * pobreza_se / pobreza_prop, 1),
                           pobreza_LI = pobreza_prop - pobreza_me,
                           pobreza_LS = pobreza_prop + pobreza_me,
                           pobreza_deff = round(pobreza_deff, 1),
                           pobrezaExtr_prop = round(pobrezaExtr_prop, 2), 
                           pobrezaExtr_se = round(pobrezaExtr_se, 4),
                           pobrezaExtr_me = round(qnorm(1-(1-conf)/2) * pobrezaExtr_se,4),
                           pobrezaExtr_mer = round(pobrezaExtr_me / pobrezaExtr_prop, 4),
                           pobrezaExtr_cve = round(100 * pobrezaExtr_se / pobrezaExtr_prop, 1),
                           pobrezaExtr_LI = pobrezaExtr_prop - pobrezaExtr_me,
                           pobrezaExtr_LS = pobrezaExtr_prop + pobrezaExtr_me,
                           pobrezaExtr_deff = round(pobrezaExtr_deff, 1),
                           IPM_prop = round(IPM_prop, 2),
                           IPM_se = round(IPM_se, 4),
                           IPM_me = round(qnorm(1-(1-conf)/2) * IPM_se,4),
                           IPM_mer = round(IPM_me / IPM_prop, 4),
                           IPM_cve = round(100 * IPM_se / IPM_prop,1),
                           IPM_LI = IPM_prop - IPM_me,
                           IPM_LS = IPM_prop + IPM_me,
                           IPM_deff = round(IPM_deff, 1),
                           Desoc_prop = round(Desoc_prop, 2),
                           Desoc_se = round(Desoc_se, 4),
                           Desoc_me = round(qnorm(1-(1-conf)/2) * Desoc_se,4),
                           Desoc_mer = round(Desoc_me / Desoc_prop, 4),
                           Desoc_cve = round(100 * Desoc_se / Desoc_prop,1),
                           Desoc_LI = Desoc_prop - Desoc_me,
                           Desoc_LS = Desoc_prop + Desoc_me,
                           Desoc_deff = round(Desoc_deff, 1)) %>%
                    select(Area,
                           pobreza_prop, pobreza_se, pobreza_me, pobreza_mer,
                           pobreza_cve, pobreza_LI, pobreza_LS, pobreza_deff,
                           pobrezaExtr_prop, pobrezaExtr_se, pobrezaExtr_me, pobrezaExtr_mer,
                           pobrezaExtr_cve, pobrezaExtr_LI, pobrezaExtr_LS, pobrezaExtr_deff,
                           IPM_prop, IPM_se, IPM_me, IPM_mer,
                           IPM_cve, IPM_LI, IPM_LS, IPM_deff,
                           Desoc_prop, Desoc_se, Desoc_me, Desoc_mer,
                           Desoc_cve, Desoc_LI, Desoc_LS, Desoc_deff,
                           N_activos, N 
          )
```

Presentamos a continuación las estimaciones resultantes


```{r, warning=FALSE, message=FALSE}
df_estima_pobreza <- df_estima_indicadores %>% select(Area, starts_with("pobreza_")) %>% 
                     pivot_longer(starts_with("pobreza_"), 
                                        names_to = "variable",
                                        values_to = "indicador") %>%
  reshape2::dcast(formula =  variable ~ Area , value.var = "indicador") %>%
  mutate(variable = gsub("pobreza_", "", variable)) %>% 
  select(Estimadores = variable, Urbana, Rural)
df_estima_pobreza <- df_estima_pobreza[
      match(c("prop", "se", "me", "mer", "cve", "LI", "LS", "deff"),   
           df_estima_pobreza$Estimadores),]
```


```{r, warning=FALSE, message=FALSE}
df_estima_pobreza <- df_estima_indicadores %>% select(Area, starts_with("pobrezaExtr_")) %>% 
                          pivot_longer(starts_with("pobrezaExtr_"), 
                                        names_to = "variable",
                                        values_to = "indicador") %>%
  reshape2::dcast(formula =  variable ~ Area , value.var = "indicador") %>%
  mutate(variable = gsub("pobrezaExtr_", "", variable)) %>%
 select(Estimadores = variable, Urbana, Rural)
  df_estima_pobreza <- df_estima_pobreza[
      match(c("prop", "se", "me", "mer", "cve", "LI", "LS", "deff"),   
           df_estima_pobreza$Estimadores),]
```


```{r, warning=FALSE, message=FALSE}
df_estima_pobrezaExtrema <- df_estima_indicadores %>% select(Area, starts_with("pobrezaExtr_")) %>% 
                          pivot_longer(starts_with("pobrezaExtr_"), 
                                        names_to = "variable",
                                        values_to = "indicador") %>%
  reshape2::dcast(formula =  variable ~ Area , value.var = "indicador") %>%
  mutate(variable = gsub("pobrezaExtr_", "", variable)) %>%
select(Estimadores = variable, Urbana, Rural) 
df_estima_pobrezaExtrema <- df_estima_pobrezaExtrema[
      match(c("prop", "se", "me", "mer", "cve", "LI", "LS", "deff"),   
           df_estima_pobrezaExtrema$Estimadores),]
```



```{r, warning=FALSE, message=FALSE}
df_estima_IPM <- df_estima_indicadores %>% select(Area, starts_with("IPM_")) %>% 
                          pivot_longer(starts_with("IPM_"), 
                                        names_to = "variable",
                                        values_to = "indicador") %>%
  reshape2::dcast(formula =  variable ~ Area , value.var = "indicador") %>%
  mutate(variable = gsub("IPM_", "", variable)) %>%
  select(Estimadores = variable, Urbana, Rural) 
  df_estima_IPM <- df_estima_IPM[
      match(c("prop", "se", "me", "mer", "cve", "LI", "LS", "deff"),   
           df_estima_IPM$Estimadores),]
```


```{r, warning=FALSE, message=FALSE}
df_estima_desoc <- df_estima_indicadores %>% select(Area, starts_with("Desoc_")) %>% 
                          pivot_longer(starts_with("Desoc_"), 
                                        names_to = "variable",
                                        values_to = "indicador") %>%
  reshape2::dcast(formula =  variable ~ Area , value.var = "indicador") %>%
  mutate(variable = gsub("Desoc_", "", variable)) %>%
  select(Estimadores = variable, Urbana, Rural) 
  df_estima_desoc <- df_estima_desoc[
      match(c("prop", "se", "me", "mer", "cve", "LI", "LS", "deff"),   
           df_estima_desoc$Estimadores),]
```



Los indicadores de pobreza son:

```{r, warning=FALSE, message=FALSE}
TablaEditada_Pobrezas <- cbind(df_estima_IPM, df_estima_pobreza[,-1], df_estima_pobrezaExtrema[,-1])
colnames(TablaEditada_Pobrezas) <- c("Estimadores", "Urbano_IPM", "Rural_IPM", 
                                     "Urbano_Pob", "Rural_Pob", 
                                     "Urbano_PobExtrem","Rural_PobExtrem")

tipologias_pobrezas <- data.frame(col_keys = colnames(TablaEditada_Pobrezas),
                         what = c("Estimadores", "IPM", "IPM", "Pobreza", "Pobreza",
                                  "Pobreza Extrema", "Pobreza Extrema"),
                         measure = c("Estimadores", "Urbano", "Rural", "Urbano", "Rural",
                                                 "Urbano", "Rural"))  
TablaEditada_Pobrezas_ft <- TablaEditada_Pobrezas %>%  flextable() %>% 
  set_header_df(mapping = tipologias_pobrezas, key = "col_keys") %>%
  merge_h(part = "header") %>% set_header_df(mapping = tipologias_pobrezas, key = "col_keys") %>%
   merge_v(j = "Estimadores", part = "header") %>%
   merge_at(i = 1, j = 2:3, part = "header") %>% 
  merge_at(i = 1, j = 4:5, part = "header") %>% 
  merge_at(i = 1, j = 6:7, part = "header") %>% theme_vanilla() %>%
  fix_border_issues()
TablaEditada_Pobrezas_ft %>% print()
```
Las estimación de la tasa de desempleo es:

```{r, warning=FALSE, message=FALSE}
tipologias_desocupacion <- data.frame(col_keys = colnames(df_estima_desoc),
                         what = c("Estimadores", "Tasa de desocupación", "Tasa de desocupación"),
                         measure = c("Estimadores", "Urbano", "Rural"))  
TablaEditada_Desoc_ft <- df_estima_desoc %>%  flextable() %>% 
  set_header_df(mapping = tipologias_desocupacion, key = "col_keys") %>%
  merge_h(part = "header") %>% set_header_df(mapping = tipologias_desocupacion, key = "col_keys") %>%
   merge_v(j = "Estimadores", part = "header") %>%
   merge_at(i = 1, j = 2:3, part = "header") %>% 
   theme_vanilla() %>%
  fix_border_issues() 
TablaEditada_Desoc_ft %>% print()
```




# 4. Parámetros para tablas de muestreo

El objetivo de los procesos desarrollados en el script es generar diferentes tamaños de muestra para el área urbana, rural y nacional para los siguientes indicadores:

* Razón de desocupación
* Pobreza monetaria no extrema
* Pobreza monetaria extrema
* Pobreza multidimensional (IPM)

En primer lugar generamos una tabla a partir de información censal y de la encuesta y con los siguientes argumentos los cuales deben ser especificados como argumentos en la función. La función tiene dos vectores que se debe establecer:

* Los margenes de error de cada indicador: me_desoc, me_pobMonet, me_pobMonetExtr, me_IPM, estos indicadores se establecerán a partir de las necesidades del Instituto Nacional de Estadística de Costa Rica y usuarios de la información: 
* Confiablidad de cada indicador (por defecto 0.95): conf_desoc, conf_pobMonet, conf_pobMonetExtr, conf_IPM

Es este paso se debe definir la precisión esperada en términos de coeficientes de variación:

```{r, warning=FALSE, message=FALSE}
df_num_perXhog <- df_encuesta %>% group_by(areageo2, id_hogar) %>% summarise(cuenta = n()) %>% group_by(areageo2) %>% summarise(num_persXhog = mean(cuenta))

M_Urbana <- con_numUpmXzona$num_upms[con_numUpmXzona$ID_ZONA == 1]
M_rural <- con_numUpmXzona$num_upms[con_numUpmXzona$ID_ZONA == 2]

N_Urbana <- df_encuesta$factorex[df_encuesta$areageo2 == 1] %>% sum()
N_rural <- df_encuesta$factorex[df_encuesta$areageo2 == 2] %>% sum()

# Número de personas por hogar según el censo
b_Urbana <- df_num_perXhog$num_persXhog[df_num_perXhog$areageo2 == 1] 
b_rural <- df_num_perXhog$num_persXhog[df_num_perXhog$areageo2 == 2] 

# Número de hogares encuestadas por UPM (encuesta de hogares)
#nII_hog = df_encuesta %>% group_by(upm) %>% summarise(nII = n_distinct(id_hogar)) %>% pull(nII) %>% mean() 

nII_hog_Urbana = df_encuesta %>% filter(areageo == 1) %>% group_by(upm) %>% 
                summarise(nII = n_distinct(id_hogar)) %>% pull(nII) %>% mean() 
nII_hog_rural = df_encuesta %>% filter(areageo == 2) %>% group_by(upm) %>% 
                summarise(nII = n_distinct(id_hogar)) %>% pull(nII) %>% mean() 

# Número de personas encuestadas por UPM (encuesta de hogares)
#nII_pers = df_encuesta  %>% group_by(upm) %>% summarise(nII = n()) %>% pull(nII) %>% mean() 
nII_pers_Urbana = df_encuesta %>% filter(areageo == 1) %>% group_by(upm) %>% 
                  summarise(nII = n()) %>% pull(nII) %>% mean() 
nII_pers_rural = df_encuesta %>% filter(areageo == 2) %>% group_by(upm) %>% 
                 summarise(nII = n()) %>% pull(nII) %>% mean() 


df_ParamGenerales <- data.frame(Area = c("Urbana",  "Rural"), 
                         M = c(M_Urbana, M_rural),
                         N = c(N_Urbana, N_rural),
                         b = c(b_Urbana, b_rural),
                         nII_hog = c(nII_hog_Urbana, nII_hog_rural), # El número de hogares por UPM en la encuesta
                         nII_pers = c(nII_pers_Urbana, nII_pers_rural)
                         )
flextable(df_ParamGenerales)
```


## 4.1. Población económicamente activa

Para calcular las tablas de muestreo debemos calcular la proporción de población económicamente activa y la proporciónde hogares sobre los cuales se calcula los indicadores de pobreza (r = 1):

```{r}
r_pobreza_Urbana <- 1
r_pobreza_Rural <- 1

r_pobrezaExtr_Urbana <- 1
r_pobrezaExtr_Rural <- 1

r_IPM_Urbana <- 1
r_IPM_Rural <- 1

r_desoc_Urbana <-  sum(df_encuesta$activos[df_encuesta$areageo2 == 1] *                
                         df_encuesta$factorex[df_encuesta$areageo2 == 1], na.rm = T) /
                        sum(df_encuesta$factorex[df_encuesta$areageo2 == 1], na.rm = T)

r_desoc_Rural <-  sum(df_encuesta$activos[df_encuesta$areageo2 == 2] *                
                        df_encuesta$factorex[df_encuesta$areageo2 == 2], na.rm = T) /
                 sum(df_encuesta$factorex[df_encuesta$areageo2 == 2], na.rm = T)

df_ParamGenerales$r_pobreza <- c(r_pobreza_Urbana, r_pobreza_Rural)
df_ParamGenerales$r_pobrezaExtr <- c(r_pobrezaExtr_Urbana, r_pobrezaExtr_Rural)
df_ParamGenerales$r_IPM <- c(r_IPM_Urbana, r_IPM_Rural)
df_ParamGenerales$r_desoc <- c(r_desoc_Urbana, r_desoc_Rural)
df_ParamGenerales %>% flextable()
```


## 4.2. Correlación intraclásica

El coeficiente de correlación de las variables de interés determina en gran medida el tamaño de las tablas de muestra.


A continuación estimamos el coeficiente de correlación intraclásica para la pobreza monetaria y el IPM con la encuesta de hogares de Costa Rica del año 2020:

```{r, warning=FALSE, message=FALSE}
f_indicador <- function(deff_indicador){
filtro_area_urbana <-  df_ParamGenerales$Area == "Urbana"
filtro_area_rural <-  df_ParamGenerales$Area == "Rural"

nII_pers_Urbana <- df_ParamGenerales$nII_pers[df_ParamGenerales$Area == "Urbana"]
nII_pers_Rural <- df_ParamGenerales$nII_pers[df_ParamGenerales$Area == "Rural"]

# deff =  1 + (n-1) * rho, despejando:  rho = (deff - 1) / (n - 1)
rho_Urbana <- (deff_indicador[filtro_area_urbana] - 1) / (nII_pers_Urbana - 1)
rho_Rural <- (deff_indicador[filtro_area_rural] - 1) / (nII_pers_rural - 1)
salida <- list(rho_Urbana, rho_Rural)
names(salida) <- c("rho_Urbana", "rho_Rural")
salida
}

rho_pobreza_Urbana <- f_indicador(df_estima_indicadores$pobreza_deff)$rho_Urbana
rho_pobreza_Rural <- f_indicador(df_estima_indicadores$pobreza_deff)$rho_Rural

rho_pobrezaExtr_Urbana <- f_indicador(df_estima_indicadores$pobrezaExtr_deff)$rho_Urbana
rho_pobrezaExtr_Rural <- f_indicador(df_estima_indicadores$pobrezaExtr_deff)$rho_Rural

rho_IPM_Urbana <- f_indicador(df_estima_indicadores$IPM_deff)$rho_Urbana
rho_IPM_Rural <- f_indicador(df_estima_indicadores$IPM_deff)$rho_Rural

rho_Desoc_Urbana <- f_indicador(df_estima_indicadores$Desoc_deff)$rho_Urbana
rho_Desoc_Rural <- f_indicador(df_estima_indicadores$Desoc_deff)$rho_Rural

df_rho <- data.frame(Area = c("Urbana", "Rural"), 
                             rho_pobreza = c(rho_pobreza_Urbana, rho_pobreza_Rural),
          rho_pobrezaExtrema = c(rho_pobrezaExtr_Urbana,        
                                      rho_pobrezaExtr_Rural),
                     rho_IPM = c(rho_IPM_Urbana, rho_IPM_Rural),
                     rho_Desoc = c(rho_Desoc_Urbana, rho_Desoc_Rural)
                             )

names(df_rho) <- c("Area", "rho pobreza.", "rho pobreza extrema","rho IPM", "rho Tasa Desocup.")
flextable::flextable(df_rho)
```
El coeficiente de correlación intraclásica junto con los parámetros definidos inicialmente en la tabla df_parametros_TablasMuestreo permitirán elaborar las tablas de muestreo para los diferentes indicadores trazadoras de la encuesta.

# 5. Tablas de muestreo


Para elaborar las tablas de muestreo utilizaremos las medidas de precisión definidas por el INE de Costa Rica mediante sesiones de grupos focales. Las estimaciones puntuales se estimana a partir de la encuesta con excepción de la tasa de desocupación la cual en el año 2020 fue más alta que en años anteriores y siguientes (18 % y 15 %). Esta alta tasa de desempleo conlleva a tamaños de muestreo mucho menos existentes. Se fijará la tasa de desempleo en un 10%


## 5.1. Configuración de estimaciones puntuales y medidas de precisión

En esta parte es importante que los técnicos del INEC de Costa Rica configuren las proporciones esperadas y los coeficientes de variación máximos, a partir de las necesidades específicas del país, y en concordancia con las encuestas más recientes y el censo de población. 

```{r}
# Estos valores son fijados por el INE:

# tasa de desocupación fijado más baja que la estimación de la encuesta 2020
# Estos parámetros son los esperados en un periodo regular (fijado por el INE)
P_desoc_fijado_Urbana <- 0.1
P_desoc_fijado_Rural <- 0.1


# Los coeficientes de variación vienen de una discusión interna con los usuarios 
# de la encuesta, en cuanto a la precisión esperada en el periodo intercensal
# Focus group
cve_desoc_deseado_Urbana <- 0.035
cve_desoc_deseado_Rural <- 0.038

# Estimaciones puntuales de indicadores de pobreza a partir de las encuestas
# ENAHO2020
P_pobreza_fijado_Urbana <- df_estima_indicadores$pobreza_prop[df_estima_indicadores$Area == "Urbana"]
P_pobreza_fijado_Rural <- df_estima_indicadores$pobreza_prop[df_estima_indicadores$Area == "Rural"]

# Los coeficientes de variación vienen de una discusión interna con los usuarios 
# de la encuesta, en cuanto a la precisión esperada en el periodo intercensal
# Focus group
cve_pobreza_fijado_Urbana <- 0.05
cve_pobreza_fijado_Rural <- 0.05

# Estimaciones puntuales de indicadores de pobreza a partir de las encuestas
# ENAHO2020
P_pobrezaExtr_fijado_Urbana <- df_estima_indicadores$pobrezaExtr_prop[df_estima_indicadores$Area == "Urbana"]
P_pobrezaExtr_fijado_Rural <- df_estima_indicadores$pobrezaExtr_prop[df_estima_indicadores$Area == "Rural"]

# Los coeficientes de variación vienen de una discusión interna con los usuarios 
# de la encuesta, en cuanto a la precisión esperada en el periodo intercensal
# Focus group
cve_pobrezaExtr_fijado_Urbana <- 0.09
cve_pobrezaExtr_fijado_Rural <- 0.09

# Estimaciones puntuales de indicadores de pobreza a partir de las encuestas
# ENAHO2020
P_IPM_fijado_Urbana <- df_estima_indicadores$IPM_prop[df_estima_indicadores$Area == "Urbana"]
P_IPM_fijado_Rural <- df_estima_indicadores$IPM_prop[df_estima_indicadores$Area == "Rural"]

# Los coeficientes de variación vienen de una discusión interna con los usuarios 
# de la encuesta, en cuanto a la precisión esperada en el periodo intercensal
# Focus group
cve_IPM_fijado_Urbana <- 0.05
cve_IPM_fijado_Rural <- 0.05

df_ValoresFijados <- data.frame(Area = c("Urbana", "Rural"),
                                pobreza_prop = c(P_pobreza_fijado_Urbana, P_pobreza_fijado_Rural),
                                pobreza_cve = c(cve_pobreza_fijado_Urbana, cve_pobreza_fijado_Rural),
                                pobrezaExtr_prop = c(P_pobrezaExtr_fijado_Urbana, P_pobrezaExtr_fijado_Rural),
                                pobrezaExtr_cve = c(cve_pobrezaExtr_fijado_Urbana, cve_pobrezaExtr_fijado_Rural),
                                IPM_prop = c(P_IPM_fijado_Urbana, P_IPM_fijado_Rural),
                                IPM_cve = c(cve_IPM_fijado_Urbana, cve_IPM_fijado_Rural),
                                Desoc_prop = c(P_desoc_fijado_Urbana, P_desoc_fijado_Rural),
                                Desoc_cve= c(cve_desoc_deseado_Urbana, cve_desoc_deseado_Rural)
                                 )

df_ValoresFijados %>% flextable()
```


## 5.2. Estimación de otras medidas de precisión para los valores fijados para las diferentes variables trazadoras

Para calcular las tablas de muestreo requerimos disponer del margen de error relativo, podemos calcular este indicador a partir del coeficiente de variación.

Recordemos que el coeficiente de variación estimado se calcula como el cociente entre el error estándar y el parámetro de interés:

$$
CVE = \frac{\sqrt{V}(\theta)}{\theta} = \frac{S_{\hat{\theta}}}{\hat\theta}
$$
Si conocemos el CVE y el parámetro podemos obtener S como sigue:

$$
S_{\hat{\theta}} = \hat{\theta}CVE
$$
Recordemos que el margen de error es:

$$
me = z_{1-\alpha/2}S_{\hat{\theta}}= z_{1-\alpha/2}\hat{\theta}CVE
$$

El margen de error relativo puede calcularse facilmente a partir del margen de error:

$$
mer = \frac{me}{\hat{\theta}}
$$

Calculamos el margen de error, margen de error relativo, error estándar y los límites del intervalo de confianza del 95%.

```{r}
conf <- 0.95
df_ValoresFijados <- df_ValoresFijados %>%
                    mutate(pobreza_me =  qnorm(1-(1-conf)/2) * pobreza_cve * pobreza_prop, 
                           pobreza_mer = pobreza_me / pobreza_prop,
                           pobreza_se = pobreza_cve * pobreza_prop,
                           pobreza_LI = pobreza_prop - pobreza_me,
                           pobreza_LS = pobreza_prop + pobreza_me,
                           pobrezaExtr_me =  qnorm(1-(1-conf)/2) * pobrezaExtr_cve * pobrezaExtr_prop, 
                           pobrezaExtr_mer = pobrezaExtr_me / pobrezaExtr_prop,
                           pobrezaExtr_se = pobrezaExtr_cve * pobrezaExtr_prop,
                           pobrezaExtr_LI = pobrezaExtr_prop - pobrezaExtr_me,
                           pobrezaExtr_LS = pobrezaExtr_prop + pobrezaExtr_me,
                           IPM_me =  qnorm(1-(1-conf)/2) * IPM_cve * IPM_prop, 
                           IPM_mer = IPM_me / IPM_prop,
                           IPM_se = IPM_cve * IPM_prop,
                           IPM_LI = IPM_prop - IPM_me,
                           IPM_LS = IPM_prop + IPM_me,
                           Desoc_me =  qnorm(1-(1-conf)/2) * Desoc_cve * Desoc_prop, 
                           Desoc_mer = Desoc_me / Desoc_prop,
                           Desoc_se = Desoc_cve * Desoc_prop,
                           Desoc_LI = Desoc_prop - Desoc_me,
                           Desoc_LS = Desoc_prop + Desoc_me) %>%
                    select(Area, pobreza_prop, pobreza_se, pobreza_me, pobreza_mer, pobreza_cve, pobreza_LI, pobreza_LS,
pobrezaExtr_prop, pobrezaExtr_se, pobrezaExtr_me, pobrezaExtr_mer, pobrezaExtr_cve, pobrezaExtr_LI, pobrezaExtr_LS,
IPM_prop, IPM_se, IPM_me, IPM_mer, IPM_cve, IPM_LI, IPM_LS,
Desoc_prop, Desoc_se, Desoc_me, Desoc_mer, Desoc_cve, Desoc_LI, Desoc_LS)

df_ValoresFijados %>% flextable()
```


## 5.3. Generación de las tablas de muestreo

Para identificar los indicadores del área urbano y rural calculamos un vector lógico que permite filtrar rapidamente la información:

```{r}
indice_Urbana <- which(df_ValoresFijados$Area == "Urbana")
indice_Rural <- which(df_ValoresFijados$Area == "Rural")
```

Calculamos la tabla de muestreo para la pobreza monetaria:


```{r}
tablaMuestreo_pobreza_Urbana <- ss4HHSp(N = df_ParamGenerales$N[indice_Urbana],
M = df_ParamGenerales$M[indice_Urbana], 
r = df_ParamGenerales$r_desoc[indice_Urbana], 
b = df_ParamGenerales$b[indice_Urbana],
rho = df_rho$`rho pobreza.`[df_rho$Area == "Urbana"],
P = df_ValoresFijados$pobreza_prop[indice_Urbana], 
delta = df_ValoresFijados$pobreza_mer[indice_Urbana],
conf = 0.95, m = 5:15)

tablaMuestreo_pobreza_Rural <- ss4HHSp(N = df_ParamGenerales$N[indice_Rural],
M = df_ParamGenerales$M[indice_Rural], 
r = df_ParamGenerales$r_desoc[indice_Rural], 
b = df_ParamGenerales$b[indice_Rural],
rho = df_rho$`rho pobreza.`[df_rho$Area == "Rural"],
P = df_ValoresFijados$pobreza_prop[indice_Rural], 
delta = df_ValoresFijados$pobreza_mer[indice_Rural],
conf = 0.95, m = 5:15)
```



Calculamos la tabla de muestreo para la pobreza extrema:

```{r}
tablaMuestreo_pobrezaExtr_Urbana <- ss4HHSp(N = df_ParamGenerales$N[indice_Urbana],
M = df_ParamGenerales$M[indice_Urbana], 
r = df_ParamGenerales$r_desoc[indice_Urbana], 
b = df_ParamGenerales$b[indice_Urbana],
rho = df_rho$`rho pobreza extrema`[df_rho$Area == "Urbana"],
P = df_ValoresFijados$pobrezaExtr_prop[indice_Urbana], 
delta = df_ValoresFijados$pobrezaExtr_mer[indice_Urbana],
conf = 0.95, m = 5:15)

tablaMuestreo_pobrezaExtr_Rural <- ss4HHSp(N = df_ParamGenerales$N[indice_Rural],
M = df_ParamGenerales$M[indice_Rural], 
r = df_ParamGenerales$r_desoc[indice_Rural], 
b = df_ParamGenerales$b[indice_Rural],
rho = df_rho$`rho pobreza extrema`[df_rho$Area == "Rural"],
P = df_ValoresFijados$pobrezaExtr_prop[indice_Rural], 
delta = df_ValoresFijados$pobrezaExtr_mer[indice_Rural],
conf = 0.95, m = 5:15)
```


Calculamos la tabla de muestreo para el IPM:

```{r}
tablaMuestreo_IPM_Urbana <- ss4HHSp(N = df_ParamGenerales$N[indice_Urbana],
M = df_ParamGenerales$M[indice_Urbana], 
r = df_ParamGenerales$r_desoc[indice_Urbana], 
b = df_ParamGenerales$b[indice_Urbana],
rho = df_rho$`rho IPM`[df_rho$Area == "Urbana"],
P = df_ValoresFijados$IPM_prop[indice_Urbana], 
delta = df_ValoresFijados$IPM_mer[indice_Urbana],
conf = 0.95, m = 5:15)

tablaMuestreo_IPM_Rural <- ss4HHSp(N = df_ParamGenerales$N[indice_Rural],
M = df_ParamGenerales$M[indice_Rural], 
r = df_ParamGenerales$r_desoc[indice_Rural], 
b = df_ParamGenerales$b[indice_Rural],
rho = df_rho$`rho IPM`[df_rho$Area == "Rural"],
P = df_ValoresFijados$IPM_prop[indice_Rural], 
delta = df_ValoresFijados$IPM_mer[indice_Rural],
conf = 0.95, m = 5:15)
```


Calculamos la tabla de muestreo para la tasa de desocupación:


```{r}
tablaMuestreo_desoc_Urbana <- ss4HHSp(N = df_ParamGenerales$N[indice_Urbana],
M = df_ParamGenerales$M[indice_Urbana], 
r = df_ParamGenerales$r_desoc[indice_Urbana], 
b = df_ParamGenerales$b[indice_Urbana],
rho = df_rho$`rho Tasa Desocup.`[df_rho$Area == "Urbana"],
P = df_ValoresFijados$Desoc_prop[indice_Urbana], 
delta = df_ValoresFijados$Desoc_mer[indice_Urbana],
conf = 0.95, m = 5:15)

tablaMuestreo_desoc_Rural <- ss4HHSp(N = df_ParamGenerales$N[indice_Rural],
M = df_ParamGenerales$M[indice_Rural], 
r = df_ParamGenerales$r_desoc[indice_Rural], 
b = df_ParamGenerales$b[indice_Rural],
rho = df_rho$`rho Tasa Desocup.`[df_rho$Area == "Rural"],
P = df_ValoresFijados$Desoc_prop[indice_Rural], 
delta = df_ValoresFijados$Desoc_mer[indice_Rural],
conf = 0.95, m = 5:15)
```


## 5.4. Integración de tablas nacionales

Integrarlas las  tablas de muestreo (Urbana y rural) en una nacional, para lograr lo anterior desarrollamos una función que podamos aplicar.

```{r}
# tabla_muestreo_urbano <- tablaMuestreo_pobreza_Urbana
# tabla_muestreo_rural <- tablaMuestreo_pobreza_Rural
#  str_indicador = "pobreza_prop" 
#  str_cve = "pobreza_cve"
#  str_N = "N"

# tabla_muestreo_urbano = tablaMuestreo_desoc_Urbana;
#                        tabla_muestreo_rural = tablaMuestreo_desoc_Rural;
#                        str_indicador = "Desoc_prop";
#                        str_cve = "Desoc_cve";
#                        str_N = "N_activos";

f_CompletarTablaNacional <- function(tabla_muestreo_urbano, tabla_muestreo_rural, str_indicador, str_cve, str_N){
tablaMuestreo_nacional <- tabla_muestreo_urbano


tablaMuestreo_nacional$PSUinSample <- tabla_muestreo_urbano$PSUinSample + 
                                              tabla_muestreo_rural$PSUinSample

tablaMuestreo_nacional$HouseholdsInSample  <- tabla_muestreo_urbano$HouseholdsInSample + 
                                              tabla_muestreo_rural$HouseholdsInSample

tablaMuestreo_nacional$PersonsInSample  <- tabla_muestreo_urbano$PersonsInSample + 
                                              tabla_muestreo_rural$PersonsInSample

tablaMuestreo_nacional$PersonsPerPSU <- tablaMuestreo_nacional$PersonsInSample /  
                                        tablaMuestreo_nacional$PSUinSample  


V_MAS_Urbana <- ((df_ValoresFijados[[str_cve]][1] * df_ValoresFijados[[str_indicador]][1])^2) / 
                         tabla_muestreo_urbano$DEFF

V_MAS_Rural <- ((df_ValoresFijados[[str_cve]][2] * df_ValoresFijados[[str_indicador]][2])^2) / 
                         tabla_muestreo_rural$DEFF


V_nacional <- ((df_ValoresFijados[[str_cve]][1] * df_ValoresFijados[[str_indicador]][1])^2) + ((df_ValoresFijados[[str_cve]][2] * df_ValoresFijados[[str_indicador]][2])^2) 

indicador_nacional = (df_estima_indicadores[[str_N]][1] * df_ValoresFijados[[str_indicador]][1] +
               df_estima_indicadores[[str_N]][2] * df_ValoresFijados[[str_indicador]][2]) / 
               (df_estima_indicadores[[str_N]][1] + df_estima_indicadores[[str_N]][2])
deff_nacional <- V_nacional / (V_MAS_Urbana + V_MAS_Rural)

medidas_error_nacional <- samplesize4surveys::e4p(N = df_ParamGenerales$N[1] + df_ParamGenerales$N[2], n = tablaMuestreo_nacional$PersonsInSample, 
                        P = indicador_nacional, DEFF = deff_nacional)


tablaMuestreo_nacional$DEFF <- deff_nacional

tablaMuestreo_nacional$cve <- round(medidas_error_nacional$cve / 100, 3)
tablaMuestreo_nacional$M.E. <- round(medidas_error_nacional$Margin_of_error / 100, 3)
tablaMuestreo_nacional$M.E.R <- round(medidas_error_nacional$Relative_Margin_of_error / 100, 3)

#  str_indicador = "pobreza_prop" 
str_prefijo_var <- gsub("_prop", "", str_indicador)
tabla_muestreo_urbano$cve <- round(df_ValoresFijados[[paste0(str_prefijo_var, "_cve")]][1], 3)
tabla_muestreo_urbano$M.E. <- round(df_ValoresFijados[[paste0(str_prefijo_var, "_me")]][1], 3)
tabla_muestreo_urbano$M.E.R <- round(df_ValoresFijados[[paste0(str_prefijo_var, "_mer")]][1], 3)

tabla_muestreo_rural$cve <-  round(df_ValoresFijados[[paste0(str_prefijo_var, "_cve")]][2], 3)
tabla_muestreo_rural$M.E. <- round(df_ValoresFijados[[paste0(str_prefijo_var, "_me")]][2], 3)
tabla_muestreo_rural$M.E.R <- round(df_ValoresFijados[[paste0(str_prefijo_var, "_mer")]][2], 3)
resultado <- list(tablaMuestreo_nacional, tabla_muestreo_urbano, tabla_muestreo_rural)
names(resultado) <- c("tabla_Muestreo_nacional", "tabla_Muestreo_urbano", "tabla_Muestreo_rural")
resultado
}
```

Completamos las tablas de muestreo nacional:

```{r}
tablaMuestreo_pobreza <- f_CompletarTablaNacional(tabla_muestreo_urbano = tablaMuestreo_pobreza_Urbana,
                       tabla_muestreo_rural = tablaMuestreo_pobreza_Rural,
                       str_indicador = "pobreza_prop",
                       str_cve = "pobreza_cve", 
                       str_N = "N")

tablaMuestreo_pobreza_Nacional <- tablaMuestreo_pobreza$tabla_Muestreo_nacional
tablaMuestreo_pobreza_Urbana <- tablaMuestreo_pobreza$tabla_Muestreo_urbano
tablaMuestreo_pobreza_Rural <- tablaMuestreo_pobreza$tabla_Muestreo_rural




tablaMuestreo_pobrezaExtr <- f_CompletarTablaNacional(tabla_muestreo_urbano = tablaMuestreo_pobrezaExtr_Urbana,
                       tabla_muestreo_rural = tablaMuestreo_pobrezaExtr_Rural,
                       str_indicador = "pobrezaExtr_prop",
                       str_cve = "pobrezaExtr_cve", 
                       str_N = "N")

tablaMuestreo_pobrezaExtr_Nacional <- tablaMuestreo_pobrezaExtr$tabla_Muestreo_nacional
tablaMuestreo_pobrezaExtr_Urbana <- tablaMuestreo_pobrezaExtr$tabla_Muestreo_urbano
tablaMuestreo_pobrezaExtr_Rural <- tablaMuestreo_pobrezaExtr$tabla_Muestreo_rural




tablaMuestreo_IPM <- f_CompletarTablaNacional(tabla_muestreo_urbano = tablaMuestreo_IPM_Urbana,
                       tabla_muestreo_rural = tablaMuestreo_IPM_Rural,
                       str_indicador = "IPM_prop",
                       str_cve = "IPM_cve", 
                       str_N = "N")

tablaMuestreo_IPM_Nacional <- tablaMuestreo_IPM$tabla_Muestreo_nacional
tablaMuestreo_IPM_Urbana <- tablaMuestreo_IPM$tabla_Muestreo_urbano
tablaMuestreo_IPM_Rural <- tablaMuestreo_IPM$tabla_Muestreo_rural




tablaMuestreo_desoc <- f_CompletarTablaNacional(tabla_muestreo_urbano = tablaMuestreo_desoc_Urbana,
                       tabla_muestreo_rural = tablaMuestreo_desoc_Rural,
                       str_indicador = "Desoc_prop",
                       str_cve = "Desoc_cve", 
                       str_N = "N_activos")


tablaMuestreo_desoc_Nacional <- tablaMuestreo_desoc$tabla_Muestreo_nacional
tablaMuestreo_desoc_Urbana <- tablaMuestreo_desoc$tabla_Muestreo_urbano
tablaMuestreo_desoc_Rural <- tablaMuestreo_desoc$tabla_Muestreo_rural
```
Imprimimos una por una las tablas resultantes a nivel nacional, para todos los indicadores de interés: pobreza, pobreza extrema, IPM y desocupación. 

```{r}
tablaMuestreo_desoc_Nacional %>% flextable()
```

```{r}
tablaMuestreo_IPM_Nacional %>% flextable()
```

```{r}
tablaMuestreo_pobreza_Nacional %>% flextable()
```

```{r}
tablaMuestreo_pobrezaExtr_Nacional %>% flextable()
```






# 6. Integración de costos a las tablas de muestreo


```{r}
f_costos <- function(tablaMuestreo_Urbana, tablaMuestreo_Rural, tablaMuestreo_Nacional){
tablaMuestreo_Urbana$Costos_UPM <- modelo_urbano$coefficients[1] + 
tablaMuestreo_Urbana$HouseholdsPerPSU * modelo_urbano$coefficients[2] + 
tablaMuestreo_Urbana$PSUinSample * modelo_urbano$coefficients[3] %>% round()

tablaMuestreo_Urbana$Costos_Total <- tablaMuestreo_Urbana$Costos_UPM * tablaMuestreo_Urbana$PSUinSample %>% round()


tablaMuestreo_Rural$Costos_UPM <- modelo_rural$coefficients[1] + 
tablaMuestreo_Rural$HouseholdsPerPSU * modelo_rural$coefficients[2] + 
tablaMuestreo_Rural$PSUinSample * modelo_rural$coefficients[3] %>% round()

tablaMuestreo_Rural$Costos_Total <- tablaMuestreo_Rural$Costos_UPM * tablaMuestreo_Rural$PSUinSample %>% round()



tablaMuestreo_Nacional$Costos_Total <- tablaMuestreo_Urbana$Costos_Total + 
                                             tablaMuestreo_Rural$Costos_Total %>% round()

tablaMuestreo_Nacional$Costos_UPM <- tablaMuestreo_Nacional$Costos_Total /  tablaMuestreo_Nacional$PSUinSample %>% round()

tablaMuestreo_Nacional <- tablaMuestreo_Nacional %>% 
  relocate(Costos_Total, .after = last_col())
resultado <- list(tablaMuestreo_Nacional, tablaMuestreo_Urbana, tablaMuestreo_Rural)
names(resultado) <- c("tablaMuestreo_Nacional", "tablaMuestreo_Urbana", "tablaMuestreo_Rural")
resultado
}
```


Calculamos los costos que conlleva realizar una UPM para la tasa de desocupación:

```{r}
tablaMuestreo_desoc_Urbana <-  f_costos(tablaMuestreo_Urbana = tablaMuestreo_desoc_Urbana, 
         tablaMuestreo_Rural = tablaMuestreo_desoc_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_desoc_Nacional)$tablaMuestreo_Urbana

tablaMuestreo_desoc_Rural <- f_costos(tablaMuestreo_Urbana = tablaMuestreo_desoc_Urbana, 
         tablaMuestreo_Rural = tablaMuestreo_desoc_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_desoc_Nacional)$tablaMuestreo_Rural

tablaMuestreo_desoc_Nacional <- f_costos(tablaMuestreo_Urbana = tablaMuestreo_desoc_Urbana, 
         tablaMuestreo_Rural = tablaMuestreo_desoc_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_desoc_Nacional)$tablaMuestreo_Nacional
```

```{r}
tablaMuestreo_pobreza_Urbana <- f_costos(tablaMuestreo_Urbana = tablaMuestreo_pobreza_Urbana, 
         tablaMuestreo_Rural = tablaMuestreo_pobreza_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_pobreza_Nacional)$tablaMuestreo_Urbana

tablaMuestreo_pobreza_Rural <- f_costos(tablaMuestreo_Urbana = tablaMuestreo_pobreza_Urbana, 
         tablaMuestreo_Rural = tablaMuestreo_pobreza_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_pobreza_Nacional)$tablaMuestreo_Rural

tablaMuestreo_pobreza_Nacional <- f_costos(tablaMuestreo_Urbana = tablaMuestreo_pobreza_Urbana,          tablaMuestreo_Rural = tablaMuestreo_pobreza_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_pobreza_Nacional)$tablaMuestreo_Nacional

```



```{r}
tablaMuestreo_pobrezaExtr_Urbana <- f_costos(tablaMuestreo_Urbana = tablaMuestreo_pobrezaExtr_Urbana, 
         tablaMuestreo_Rural = tablaMuestreo_pobrezaExtr_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_pobrezaExtr_Nacional)$tablaMuestreo_Urbana

tablaMuestreo_pobrezaExtr_Rural <- f_costos(tablaMuestreo_Urbana = tablaMuestreo_pobrezaExtr_Urbana, 
         tablaMuestreo_Rural = tablaMuestreo_pobrezaExtr_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_pobrezaExtr_Nacional)$tablaMuestreo_Rural

tablaMuestreo_pobrezaExtr_Nacional <- f_costos(tablaMuestreo_Urbana = tablaMuestreo_pobrezaExtr_Urbana,          tablaMuestreo_Rural = tablaMuestreo_pobrezaExtr_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_pobrezaExtr_Nacional)$tablaMuestreo_Nacional
```



```{r}
tablaMuestreo_IPM_Urbana <- f_costos(tablaMuestreo_Urbana = tablaMuestreo_IPM_Urbana, 
         tablaMuestreo_Rural = tablaMuestreo_IPM_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_IPM_Nacional)$tablaMuestreo_Urbana

tablaMuestreo_IPM_Rural <- f_costos(tablaMuestreo_Urbana = tablaMuestreo_IPM_Urbana, 
         tablaMuestreo_Rural = tablaMuestreo_IPM_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_IPM_Nacional)$tablaMuestreo_Rural

tablaMuestreo_IPM_Nacional <- f_costos(tablaMuestreo_Urbana = tablaMuestreo_IPM_Urbana,          tablaMuestreo_Rural = tablaMuestreo_IPM_Rural, 
         tablaMuestreo_Nacional = tablaMuestreo_IPM_Nacional)$tablaMuestreo_Nacional
```



# 7. Exportación de resultados

```{r}
lista_resultados_desoc <- list(tablaMuestreo_desoc_Urbana, tablaMuestreo_desoc_Rural, tablaMuestreo_desoc_Nacional)
names(lista_resultados_desoc) <- c("tablaMuestreo_desoc_Urbana", "tablaMuestreo_desoc_Rural", "tablaMuestreo_desoc_Nacional")

lista_resultados_pobreza <- list(tablaMuestreo_pobreza_Urbana, tablaMuestreo_pobreza_Rural, tablaMuestreo_pobreza_Nacional)
names(lista_resultados_pobreza) <- c("tablaMuestreo_pobreza_Urbana", "tablaMuestreo_pobreza_Rural", "tablaMuestreo_pobreza_Nacional")

lista_resultados_pobrezaExtr <- list(tablaMuestreo_pobrezaExtr_Urbana, tablaMuestreo_pobrezaExtr_Rural, tablaMuestreo_pobrezaExtr_Nacional)
names(lista_resultados_pobrezaExtr) <- c("tablaMuestreo_pobrezaExtr_Urbana", "tablaMuestreo_pobrezaExtr_Rural", "tablaMuestreo_pobrezaExtr_Nacional")

lista_resultados_IPM <- list(tablaMuestreo_IPM_Urbana, tablaMuestreo_IPM_Rural, tablaMuestreo_IPM_Nacional)
names(lista_resultados_IPM) <- c("tablaMuestreo_IPM_Urbana", "tablaMuestreo_IPM_Rural", "tablaMuestreo_IPM_Nacional")

lista_nacional <- list(tablaMuestreo_desoc_Nacional, tablaMuestreo_pobreza_Nacional,
                       tablaMuestreo_pobrezaExtr_Nacional, tablaMuestreo_IPM_Nacional)
names(lista_nacional) <- c("tablaMuestreo_desoc_Nacional", "tablaMuestreo_pobreza_Nacional",
                       "tablaMuestreo_pobrezaExtr_Nacional", "tablaMuestreo_IPM_Nacional")

```

Exportamos los resultados:

```{r}
setwd("../output")
write_xlsx(lista_resultados_desoc, "resultados_desoc.xlsx")
write_xlsx(lista_resultados_pobreza, "resultados_pobreza.xlsx")
write_xlsx(lista_resultados_pobrezaExtr, "resultados_pobrezaExtr.xlsx")
write_xlsx(lista_resultados_IPM, "resultados_IPM.xlsx")
write_xlsx(lista_nacional, "resultados_nacional.xlsx")
```

